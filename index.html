<!DOCTYPE html>
<html>
<head>
  <style>
  /* Universal box-sizing for consistent sizing */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  /* Mobile Styles - Enhanced for touch and small screens */
  @media (max-width: 768px) {
    /* Make minimize buttons touch-friendly */
    #sidebar-minimize-btn,
    #main-controls .controls-header #controls-minimize-btn,
    #legend-minimize-btn {
      position: absolute !important;
      top: 8px !important;
      right: 8px !important;
      z-index: 10002 !important;
      font-size: 20px !important;
      background: #2563eb !important;
      color: #fff !important;
      border-radius: 8px !important;
      min-width: 44px !important;
      min-height: 44px !important;
      border: none !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
      padding: 8px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-weight: 700 !important;
      transition: background 0.2s;
      cursor: pointer;
    }
    #main-controls .controls-header #controls-minimize-btn {
      left: 8px !important;
      right: auto !important;
    }
    .legend-header {
      position: relative !important;
      min-height: 56px;
      padding: 12px 60px 12px 16px !important;
    }
    .legend-header h4 {
      margin: 0 !important;
      font-size: 16px !important;
    }
  }
  @media (max-width: 768px) {
    /* Legend at bottom of screen on mobile */
    .legend {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      max-width: 100vw !important;
      z-index: 10005 !important;
      background: #fff !important;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.15) !important;
      border-radius: 16px 16px 0 0 !important;
      overflow-y: auto;
      max-height: 50vh;
      min-width: auto !important;
    }
    .legend.minimized {
      max-height: 56px !important;
    }
    .legend-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10006;
      border-radius: 16px 16px 0 0;
    }
    .legend-content {
      padding: 16px !important;
    }
    .legend-item {
      font-size: 14px !important;
      margin-bottom: 10px !important;
    }
    .legend-color {
      width: 20px !important;
      height: 20px !important;
      margin-right: 12px !important;
    }
  }
    .spinner svg {
      vertical-align: middle;
    }
    @keyframes spinner-rotate {
      to { transform: rotate(360deg); }
    }
    .spinner svg circle {
      animation: spinner-rotate 0.8s linear infinite;
    }
  /* Colorblind mode legend overrides - must be last in style block */
  body.colorblind-mode .legend-color {
    border: 2px dashed #333 !important;
  }
  body.colorblind-mode .legend-item {
    font-weight: bold;
    text-decoration: underline wavy #333;
  }
  /* Republican shades - Orange/Yellow palette */
  body.colorblind-mode .legend-color[style*="background: #67000d"] { background: #cc5500 !important; } /* Annihilation R */
  body.colorblind-mode .legend-color[style*="background: #a50f15"] { background: #ff6600 !important; } /* Dominant R */
  body.colorblind-mode .legend-color[style*="background: #cb181d"] { background: #ff8833 !important; } /* Stronghold R */
  body.colorblind-mode .legend-color[style*="background: #ef3b2c"] { background: #ffaa55 !important; } /* Safe R */
  body.colorblind-mode .legend-color[style*="background: #fb6a4a"] { background: #ffcc77 !important; } /* Likely R */
  body.colorblind-mode .legend-color[style*="background: #fcae91"] { background: #ffdd99 !important; } /* Lean R */
  body.colorblind-mode .legend-color[style*="background: #fee8c8"] { background: #ffeecc !important; } /* Tilt R */
  /* Tossup */
  body.colorblind-mode .legend-color[style*="background: #f7f7f7"] { background: #cccccc !important; }
  /* Democratic shades - Blue palette */
  body.colorblind-mode .legend-color[style*="background: #e1f5fe"] { background: #b3d9ff !important; } /* Tilt D */
  body.colorblind-mode .legend-color[style*="background: #c6dbef"] { background: #99ccff !important; } /* Lean D */
  body.colorblind-mode .legend-color[style*="background: #9ecae1"] { background: #66b3ff !important; } /* Likely D */
  body.colorblind-mode .legend-color[style*="background: #6baed6"] { background: #3399ff !important; } /* Safe D */
  body.colorblind-mode .legend-color[style*="background: #3182bd"] { background: #0080ff !important; } /* Stronghold D */
  body.colorblind-mode .legend-color[style*="background: #08519c"] { background: #0066cc !important; } /* Dominant D */
  body.colorblind-mode .legend-color[style*="background: #08306b"] { background: #004d99 !important; } /* Annihilation D */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Define toggleSidebar function before DOMContentLoaded
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const sidebarContent = document.querySelector('.sidebar-content');
      const sidebarHeader = document.querySelector('.sidebar-header');
      const minimizeBtn = document.getElementById('sidebar-minimize-btn');
      const floatBtn = document.getElementById('sidebar-float-toggle');
      const detailsDiv = document.getElementById('county-details');
      const contentEl = document.getElementById('county-info-content');
      
      if (sidebar && sidebar.classList.contains('minimized')) {
        // Expand sidebar
        sidebar.classList.remove('minimized');
        if (sidebarHeader) sidebarHeader.style.display = 'flex';
        if (sidebarContent) sidebarContent.style.display = 'block';
        if (detailsDiv) detailsDiv.style.display = 'block';
        // Ensure there's content to show
        if (contentEl && (!contentEl.innerHTML || contentEl.innerHTML.trim() === '')) {
          contentEl.innerHTML = '<p>Select a contest or county to see results.</p>';
        }
        if (minimizeBtn) {
          minimizeBtn.textContent = '‚àí';
          minimizeBtn.title = 'Minimize sidebar';
        }
        if (floatBtn) {
          floatBtn.textContent = '‚àí';
          floatBtn.title = 'Minimize sidebar';
        }
      } else if (sidebar) {
        // Minimize sidebar
        sidebar.classList.add('minimized');
        if (sidebarContent) sidebarContent.style.display = 'none';
        if (minimizeBtn) {
          minimizeBtn.textContent = '+';
          minimizeBtn.title = 'Expand sidebar';
        }
        if (floatBtn) {
          floatBtn.textContent = '+';
          floatBtn.title = 'Expand sidebar';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      var sidebar = document.getElementById('sidebar');
      var sidebarBtn = document.getElementById('sidebar-minimize-btn');
      var floatBtn = document.getElementById('sidebar-float-toggle');
      var detailsDiv = document.getElementById('county-details');
      var contentEl = document.getElementById('county-info-content');
      var statusExit = document.getElementById('status-exit');
      
      // Always start minimized and set button text
      if (sidebar) sidebar.classList.add('minimized');
      
      // Sidebar minimize button
      if (sidebarBtn) {
        sidebarBtn.textContent = '+';
        sidebarBtn.title = 'Expand sidebar';
        sidebarBtn.onclick = function() {
          toggleSidebar();
          // If no county is selected, show default message
          if (detailsDiv && contentEl && (!window.lastSelectedCounty || window.lastSelectedCounty === '')) {
            contentEl.innerHTML = '<p>Select a contest or county to see results.</p>';
            detailsDiv.style.display = 'block';
          }
        };
      }
      
      // Floating sidebar button
      if (floatBtn) {
        floatBtn.onclick = function() {
          toggleSidebar();
        };
        // Set initial float button text based on sidebar state
        if (sidebar && !sidebar.classList.contains('minimized')) {
          floatBtn.textContent = '‚àí';
          floatBtn.title = 'Minimize sidebar';
        } else {
          floatBtn.textContent = '+';
          floatBtn.title = 'Expand sidebar';
        }
      }
      
      // Status panel close button
      if (statusExit) {
        statusExit.onclick = function() {
          document.getElementById('status-panel').style.display = 'none';
        };
      }
      
      // Show default message on load
      if (detailsDiv && contentEl) {
        contentEl.innerHTML = '<p>Select a contest or county to see results.</p>';
        detailsDiv.style.display = 'block';
      }
    });
    // Zoom to county by name using turf.js
    function zoomToCounty(countyName) {
      const countiesSource = map.getSource('counties');
      if (!countiesSource || !countiesSource._data || !countiesSource._data.features) return;
      const counties = countiesSource._data.features;
      // Normalize county names for matching
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      const normTarget = normalizeCountyName(countyName);
      const countyFeature = counties.find(f => {
        const props = f.properties || {};
        const name = normalizeCountyName(props.NAME20 || props.County || props.COUNTYNAME || props.NAME || '');
        return name === normTarget;
      });
      if (!countyFeature) return;
      const bbox = turf.bbox(countyFeature);
      map.fitBounds(bbox, { padding: 40, maxZoom: 10 });
    }
  </script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <meta charset='utf-8'>
    <title>Minnesota Political Realignment Map (1992-2024)</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes'>
    <meta property="og:title" content="MN Political Realignment Map (1992-2024)">
    <meta property="og:description" content="Interactive visualization of Minnesota's political trends from 1992 to 2024, showing county-level voting patterns.">
    <meta property="og:image" content="preview.png">
    <meta name="twitter:card" content="summary_large_image">
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet'>
    <style>
/* Show floating button only when sidebar is minimized */
#sidebar-float-toggle { display: flex; position: fixed; top: 10px; right: 10px; z-index: 10010; }
/* Mobile: Larger touch-friendly floating button */
@media (max-width: 768px) {
  #sidebar-float-toggle {
    top: auto !important;
    bottom: calc(50vh + 16px) !important;
    right: 16px !important;
    width: 56px !important;
    height: 56px !important;
    font-size: 28px !important;
    border-radius: 50% !important;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2) !important;
  }
}
html, body {
  height: 100vh;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}
body {
  height: 100vh;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  overflow: hidden;
  touch-action: pan-x pan-y;
}
#map {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw !important;
  height: 100vh;
  background: #f0f4f8;
  transition: left 0.3s cubic-bezier(.4,0,.2,1), width 0.3s cubic-bezier(.4,0,.2,1);
  z-index: 1;
  touch-action: pan-x pan-y pinch-zoom;
}
/* Removed unused #map.sidebar-minimized selector for clarity */

/* Hover Tooltip */
.hover-tooltip {
  position: absolute;
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  pointer-events: none;
  z-index: 1000;
  max-width: 300px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  display: none;
  line-height: 1.4;
}

.hover-tooltip .tooltip-title {
  font-weight: bold;
  margin-bottom: 8px;
  color: #ffffff;
  border-bottom: 1px solid #444;
  padding-bottom: 6px;
}

.hover-tooltip .tooltip-trends {
  font-family: monospace;
  font-size: 12px;
}

.quick-tooltip {
  background: rgba(40, 40, 40, 0.95);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  line-height: 1.3;
}

.quick-tooltip strong {
  color: #fff;
  font-weight: 600;
}

.sidebar {
  position: absolute;
  top: 0;
  right: 0;
  width: 400px;
  height: 100vh;
  background: #fff;
  box-shadow: -2px 0 10px rgba(0,0,0,0.1);
  border-left: 1px solid #e5e7eb;
  overflow-y: auto;
  transition: width 0.3s cubic-bezier(.4,0,.2,1);
  z-index: 2;
}
/* Mobile: Full-screen sidebar */
@media (max-width: 768px) {
  .sidebar {
    position: fixed !important;
    top: 0 !important;
    right: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 10003 !important;
    box-shadow: none !important;
    border: none !important;
  }
  .sidebar-header {
    padding: 16px !important;
    border-bottom: 2px solid #e5e7eb !important;
  }
  .sidebar-header h3 {
    font-size: 18px !important;
    padding-right: 50px;
  }
  .sidebar-content {
    padding: 16px !important;
  }
  .sidebar-footer {
    padding: 16px !important;
    font-size: 14px !important;
  }
}
.sidebar.minimized {
  width: 0 !important;
  min-width: 0 !important;
  max-width: 0 !important;
  overflow: hidden !important;
  pointer-events: none;
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
  padding: 0 !important;
  margin: 0 !important;
}
.sidebar.minimized .sidebar-content {
  display: none !important;
}
.sidebar.minimized .sidebar-header {
  display: none !important;
}
.sidebar.minimized .minimize-btn {
  display: flex !important;
  position: fixed !important;
  top: 15px;
  right: 15px;
  transform: none;
  background: #2563eb;
  color: white;
  border: 1px solid #1d4ed8;
  pointer-events: auto !important;
  cursor: pointer !important;
  z-index: 10001;
}
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}
.sidebar-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}
.sidebar-content {
  padding: 20px;
}
.minimize-btn {
  background: #2563eb;
  border: 1px solid #1d4ed8;
  border-radius: 6px;
  width: 30px;
  height: 30px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  color: white;
  transition: all 0.2s ease;
}
.minimize-btn:hover {
  background: #1d4ed8;
  border-color: #1e40af;
  transform: scale(1.05);
}

/* Main Controls */
.main-controls {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  z-index: 1000;
  min-width: 380px;
  max-width: 420px;
  transition: all 0.3s ease;
}
/* Mobile: Full-width controls at top */
@media (max-width: 768px) {
  .main-controls {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100vw !important;
    min-width: 100vw !important;
    max-width: 100vw !important;
    border-radius: 0 0 16px 16px !important;
    padding: 16px !important;
    margin: 0 !important;
    z-index: 10004 !important;
  }
  .main-controls.minimized {
    min-width: 60px !important;
    max-width: 60px !important;
    width: 60px !important;
    left: 8px !important;
    top: 8px !important;
    right: auto !important;
    border-radius: 12px !important;
  }
  .controls-header h3 {
    font-size: 16px !important;
    padding-right: 50px;
  }
  .control-group label {
    font-size: 14px !important;
  }
  .control-group select {
    padding: 12px !important;
    font-size: 15px !important;
  }
  #accessibility-toggle {
    min-width: 40px !important;
    min-height: 40px !important;
    width: 40px !important;
    height: 40px !important;
  }
}
.main-controls.minimized {
  min-width: 60px;
  max-width: 60px;
  padding: 15px;
}
.main-controls.minimized .controls-content {
  display: none;
}
.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.controls-header h3 {
  margin: 0;
  color: #1f2937;
  font-weight: 600;
  font-size: 16px;
}
.controls-content {
  position: relative;
}
.analysis-mode {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.mode-toggle {
  flex: 1;
  padding: 8px;
  text-align: center;
  border: 2px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
  font-weight: 500;
}
.mode-toggle.active {
  background: #3498db;
  color: white;
  border-color: #3498db;
}
.analysis-mode {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.mode-toggle {
  flex: 1;
  text-align: center;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
  color: #6b7280;
}
.mode-toggle.active {
  background: #2563eb;
  color: white;
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
}
.mode-toggle:hover:not(.active) {
  background: #e5e7eb;
  color: #374151;
}
.view-toggle {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
  background: #f3f4f6;
  border-radius: 8px;
  padding: 4px;
}
.control-group {
  margin-bottom: 16px;
}
.control-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #374151;
}
.control-group select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  background: white;
  font-size: 14px;
}

/* Legend */
.legend {
  position: absolute;
  bottom: 20px;
  left: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 1000;
  min-width: 250px;
  border: 1px solid #e5e7eb;
}
.legend.minimized .legend-content {
  display: none;
}
.legend-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 12px 12px 0 0;
}
.legend-header h4 {
  margin: 0;
  font-size: 1rem;
  color: #374151;
}
.legend-content {
  padding: 16px 20px;
}
.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
}
.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 3px;
  margin-right: 10px;
  flex-shrink: 0;
}
/* County Details */
.county-details {
  margin-bottom: 20px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.county-details h4 {
  margin: 0 0 12px 0;
  color: #374151;
  font-size: 16px;
  font-weight: 700;
}
/* Mobile: Better spacing for county details */
@media (max-width: 768px) {
  .county-details {
    padding: 14px !important;
    margin-bottom: 16px !important;
  }
  .county-details h4 {
    font-size: 18px !important;
  }
  #county-name {
    font-size: 20px !important;
  }
}
/* Sidebar Card Classes for Consistent Font Sizes */
.sidebar-section-title {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 6px !important;
  color: #222 !important;
}
.sidebar-winner {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 8px !important;
}
.sidebar-margin {
  font-size: 14px !important;
  font-weight: 700 !important;
  margin-bottom: 4px !important;
}
.sidebar-margin-details {
  font-size: 13px !important;
  color: #64748b !important;
  margin-bottom: 8px !important;
}
.sidebar-breakdown {
  font-size: 14px !important;
  font-weight: 600 !important;
  margin-bottom: 2px !important;
}
.statewide-results {
  margin-bottom: 20px;
  padding: 16px;
  background: #f0f9ff;
  border-radius: 8px;
  border: 1px solid #0ea5e9;
}
.statewide-results h4 {
  margin: 0 0 15px 0;
  font-size: 16px !important;
  font-weight: 700 !important;
  color: #1f2937 !important;
}
/* Mobile: Better layout for statewide results */
@media (max-width: 768px) {
  .statewide-results {
    padding: 14px !important;
  }
  .statewide-results h4 {
    font-size: 18px !important;
  }
  .statewide-margin {
    padding: 12px !important;
  }
  #statewide-temperature-bar {
    height: 36px !important;
    margin: 14px 0 !important;
  }
}

/* Statewide Results */
.statewide-results {
  border-top: 1px solid #e5e7eb;
  padding-top: 20px;
  margin-bottom: 20px;
}
.statewide-results h4 {
  margin: 0 0 15px 0;
  color: #1f2937;
  font-size: 16px;
  font-weight: 600;
}
.statewide-margin {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  margin: 10px 0;
}
.margin-text {
  font-weight: 600 !important;
  font-size: 14px !important;
}
.margin-details {
  font-size: 14px !important;
  color: #64748b !important;
  margin-top: 5px !important;
}

.findings-section {
  margin-bottom: 20px;
}
.findings-section h4 {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: #1f2937;
}
.finding-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.finding-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.finding-card h5 {
  margin: 0 0 12px 0;
  color: #1f2937;
  font-size: 14px;
  font-weight: 600;
  border-bottom: 2px solid #3b82f6;
  padding-bottom: 6px;
}
.finding-card p {
  margin: 8px 0;
  font-size: 13px;
  line-height: 1.5;
  color: #374151;
}
.finding-card ul {
  font-size: 13px;
  line-height: 1.5;
  margin: 8px 0;
  padding-left: 20px;
  color: #374151;
}
.finding-card strong {
  color: #1f2937;
  font-weight: 600;
}
.metric {
  background: #dbeafe;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: 600;
  color: #1e40af;
  display: inline-block;
  margin: 1px 2px;
  border: 1px solid #bfdbfe;
  white-space: nowrap;
}
.metric.highlight {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fecaca;
  font-weight: 700;
}
.metric.dem-highlight {
  background: #dbeafe;
  color: #1d4ed8;
  border: 1px solid #3b82f6;
  font-weight: 700;
}
.metric.swing-highlight {
  background: #fef9c3;
  color: #92400e;
  border: 1px solid #fde68a;
  font-weight: 700;
}
/* Mobile: Better readability for research findings */
@media (max-width: 768px) {
  .findings-section h4 {
    font-size: 18px !important;
  }
  .finding-card {
    padding: 14px !important;
    margin-bottom: 14px !important;
  }
  .finding-card h5 {
    font-size: 16px !important;
  }
  .finding-card p,
  .finding-card ul {
    font-size: 15px !important;
    line-height: 1.6 !important;
  }
}
.metric {
  background: #dbeafe;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
  color: #1e40af;
}

/* Mobile: Touch-friendly inputs and buttons */
@media (max-width: 768px) {
  #county-search {
    font-size: 16px !important;
    padding: 12px !important;
    border-radius: 8px !important;
  }
  .minimize-btn {
    min-width: 44px !important;
    min-height: 44px !important;
    font-size: 22px !important;
  }
  /* Ensure all buttons and interactive elements are touch-friendly */
  button, select, input, .mode-toggle {
    min-height: 44px !important;
    touch-action: manipulation;
  }
  /* Better tap highlight */
  button:active, .mode-toggle:active {
    opacity: 0.7;
    transform: scale(0.97);
  }
}

/* Mobile: panel spacing and overlap prevention */
@media (max-width: 768px) {
  :root {
    --mobile-controls-offset: 220px;
  }
  html, body {
    height: 100dvh;
  }
  #map,
  .sidebar {
    height: 100dvh !important;
  }
  .sidebar {
    top: calc(var(--mobile-controls-offset) + 8px) !important;
    height: calc(100dvh - var(--mobile-controls-offset) - env(safe-area-inset-bottom) - 8px) !important;
    border-radius: 14px 14px 0 0;
    overflow: hidden;
  }
  .main-controls {
    max-height: min(44vh, 420px);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
  }
  .main-controls.minimized {
    max-height: none;
    overflow: visible;
    min-width: 60px !important;
    max-width: 60px !important;
    width: 60px !important;
    padding: 15px !important;
  }
  .main-controls.minimized .controls-header {
    justify-content: center !important;
  }
  .main-controls.minimized .controls-header h3 {
    display: none !important;
  }
  .main-controls.minimized .controls-header > div {
    width: 100%;
    justify-content: center !important;
    gap: 0 !important;
  }
  .legend {
    top: calc(var(--mobile-controls-offset) + 8px) !important;
    bottom: calc(env(safe-area-inset-bottom) + 8px) !important;
    max-height: calc(100dvh - var(--mobile-controls-offset) - env(safe-area-inset-bottom) - 16px) !important;
    padding-bottom: env(safe-area-inset-bottom);
  }
  .legend.minimized {
    top: auto !important;
    bottom: env(safe-area-inset-bottom) !important;
    max-height: 56px !important;
  }
  .legend-content,
  .sidebar-content {
    padding-bottom: calc(18px + env(safe-area-inset-bottom)) !important;
  }
  .control-group select,
  #county-search {
    font-size: 16px !important;
  }
  .status-panel {
    left: 12px !important;
    right: 12px !important;
    width: auto !important;
    max-width: none !important;
    bottom: calc(12px + env(safe-area-inset-bottom)) !important;
  }
}

/* End of styles */

.metric {
  background: #eff6ff;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 600;
  color: #1d4ed8;
  display: inline-block;
  margin: 2px;
}

/* Status panel */
.status-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  border: 1px solid #e5e7eb;
  z-index: 1000;
  max-width: 300px;
}
    .sidebar.minimized .sidebar-footer {
      display: none !important;
    }
    #sidebar-float-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      width: 40px;
      height: 40px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      font-size: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    #sidebar-float-toggle:hover {
      background: #1746a0;
    }
    .sidebar.minimized ~ #sidebar-float-toggle {
      display: flex !important;
    }
  /* Removed empty ruleset for #map.sidebar-minimized */
    </style>
</head>
<body>
<!-- Move JS to <script> block -->
<script>
// Accessibility: Color Blind Mode Toggle
document.addEventListener('DOMContentLoaded', function() {
  var accBtn = document.getElementById('accessibility-toggle');
  var labelsBtn = document.getElementById('labels-toggle');
  function updateLegendColors() {
    var colorblind = document.body.classList.contains('colorblind-mode');
    var legendColors = document.querySelectorAll('.legend-color');
    legendColors.forEach(function(el) {
      var orig = el.getAttribute('data-orig-bg');
      if (!orig) {
        orig = el.style.background;
        el.setAttribute('data-orig-bg', orig);
      }
      if (colorblind) {
        // Map original color to colorblind-friendly color
        var cbMap = {
          '#67000d': '#ff9900',
          '#a50f15': '#ffb84d',
          '#cb181d': '#ffd699',
          '#ef3b2c': '#ffe5cc',
          '#fb6a4a': '#fff2e6',
          '#fcae91': '#ffe5cc',
          '#fee8c8': '#fff2e6',
          '#f7f7f7': '#cccccc',
          '#e1f5fe': '#3399ff',
          '#c6dbef': '#66b3ff',
          '#9ecae1': '#99ccff',
          '#6baed6': '#b3d1ff',
          '#3182bd': '#3366cc',
          '#08519c': '#003399',
          '#08306b': '#001f4d'
        };
        var match = orig.match(/#([0-9a-fA-F]{6})/);
        if (match && cbMap[match[0]]) {
          el.style.background = cbMap[match[0]];
        }
      } else {
        el.style.background = orig;
      }
    });
  }
  if (accBtn) {
    accBtn.onclick = function() {
      document.body.classList.toggle('colorblind-mode');
      updateLegendColors();
      // Reapply current contest with new color mode
      const contestSelect = document.getElementById('contestSelect');
      const contestKey = contestSelect && contestSelect.value;
      if (contestKey) {
        applyContest(contestKey);
      }
    };
  }
  
  // County Labels Toggle
  if (labelsBtn) {
    labelsBtn.onclick = function() {
      if (map.getLayer('county-label')) {
        const currentVisibility = map.getLayoutProperty('county-label', 'visibility');
        const newVisibility = currentVisibility === 'visible' ? 'none' : 'visible';
        map.setLayoutProperty('county-label', 'visibility', newVisibility);
        
        // Update button appearance
        if (newVisibility === 'none') {
          labelsBtn.style.opacity = '0.5';
          labelsBtn.title = 'Show County Labels';
        } else {
          labelsBtn.style.opacity = '1';
          labelsBtn.title = 'Hide County Labels';
        }
      }
    };
  }
  
  updateLegendColors(); // Ensure correct colors on load
});
</script>
<div id="map"></div>
  <!-- Sidebar for County Details and Analysis (single instance only) -->
    <div class="sidebar minimized" id="sidebar">
      <div class="sidebar-header" id="sidebar-header">
        <h3>üìä County Analysis</h3>
        <button class="minimize-btn" id="sidebar-minimize-btn">+</button>
      </div>
      <div class="sidebar-content">
        <div class="county-details" id="county-details" style="display: block;">
          <h4 id="county-name">Select a County</h4>
          <div id="county-info-content">
            Click on any county to see detailed election results and analysis.
          </div>
        </div>
        <div style="margin-bottom: 16px;">
          <label for="county-search" style="font-weight:600;">Search County:</label>
          <input type="text" id="county-search" placeholder="Type county name..." autocomplete="off" spellcheck="false" style="width:100%;padding:8px;border-radius:6px;margin-top:6px;margin-bottom:6px;border:1px solid #d1d5db;" />
        </div>
        <h4 id="statewide">üèõÔ∏è Minnesota Statewide</h4>
  <div style="margin:18px 0 8px 0; border-bottom:2px solid #e5e7eb;"></div>
   <div class="statewide-results" id="statewide-results">
  <h4 id="contest-name" style="margin:0 0 15px 0; font-size:16px; font-weight:700; color:#1f2937;"></h4>
      <div id="statewide-content">
        <p>Select a contest to see statewide results and margin.</p>
        <div id="statewide-temperature-bar" style="width:100%;height:24px;margin:12px 0;display:none;"></div>
      </div>
    </div>
        <div class="findings-section">
          <h4>üîç Research Findings: Minnesota Electoral Trends (1990-2024)</h4>
          
          <div class="finding-card">
            <h5>1Ô∏è‚É£ The Great Realignment: One-Directional Partisan Sorting (2008-2024)</h5>
            <p><strong>The Stark Reality of Modern Realignment:</strong> Between Barack Obama's 2008 victory and 2024, Minnesota experienced a profound one-directional political realignment. Analysis of county-level presidential results reveals an unprecedented consolidation pattern: <strong>Democrats improved their margins in only 8 of Minnesota's 87 counties</strong>, while losing ground in <strong>70 counties</strong>. Even more striking, <strong>28 counties flipped from Obama 2008 to Trump 2024</strong>, while <strong>exactly zero counties flipped from Romney 2012 to Harris 2024</strong>.</p>
            
            <p><strong>The Metro Concentration Story:</strong> Of the 8 counties where Democrats gained margin between 2008-2024, <strong>6 are Twin Cities metropolitan counties</strong>:</p>
            <ul>
              <li><strong>Hennepin County:</strong> <span class="metric dem-highlight">D+29.13% (2008)</span> ‚Üí <span class="metric dem-highlight">D+43.64% (2024)</span> ‚Äî <span class="metric swing-highlight">+14.51 point gain</span></li>
              <li><strong>Ramsey County:</strong> <span class="metric dem-highlight">D+34.58% (2008)</span> ‚Üí <span class="metric dem-highlight">D+44.33% (2024)</span> ‚Äî <span class="metric swing-highlight">+9.75 point gain</span></li>
              <li><strong>Carver County:</strong> <span class="metric">R+15.37% (2008)</span> ‚Üí <span class="metric">R+5.51% (2024)</span> ‚Äî <span class="metric swing-highlight">+9.86 point Dem gain</span></li>
              <li><strong>Dakota County:</strong> <span class="metric dem-highlight">D+5.61% (2008)</span> ‚Üí <span class="metric dem-highlight">D+13.14% (2024)</span> ‚Äî <span class="metric swing-highlight">+7.53 point gain</span></li>
              <li><strong>Washington County:</strong> <span class="metric dem-highlight">D+4.41% (2008)</span> ‚Üí <span class="metric dem-highlight">D+9.09% (2024)</span> ‚Äî <span class="metric swing-highlight">+4.68 point gain</span></li>
              <li><strong>Scott County:</strong> <span class="metric">R+11.40% (2008)</span> ‚Üí <span class="metric">R+8.66% (2024)</span> ‚Äî <span class="metric swing-highlight">+2.74 point Dem gain</span></li>
            </ul>
            <p>The only non-metro Democratic gains were <strong>Cook County</strong> (<span class="metric dem-highlight">D+23.90% (2008)</span> ‚Üí <span class="metric dem-highlight">D+35.81% (2024)</span>, North Shore, very small population) and <strong>Mower County</strong> (<span class="metric highlight">R+19.58% (2008)</span> ‚Üí <span class="metric highlight">R+10.67% (2024)</span>, contains Rochester with Mayo Clinic's college-educated workforce). This demonstrates that educational polarization, not geography alone, drives the realignment.</p>
            
            <p><strong>The Rural Collapse - Largest Democratic Losses (2008-2024):</strong> Rural Minnesota's transformation far exceeds the modest metro gains:</p>
            <ul>
              <li><strong>Murray County:</strong> <span class="metric dem-highlight">D+24.25% (2008)</span> ‚Üí <span class="metric highlight">R+43.14% (2024)</span> ‚Äî <span class="metric highlight">67.39 point loss</span></li>
              <li><strong>Marshall County:</strong> <span class="metric dem-highlight">D+0.57% (2008)</span> ‚Üí <span class="metric highlight">R+52.45% (2024)</span> ‚Äî <span class="metric highlight">53.02 point loss</span></li>
              <li><strong>Pipestone County:</strong> <span class="metric dem-highlight">D+1.59% (2008)</span> ‚Üí <span class="metric highlight">R+48.86% (2024)</span> ‚Äî <span class="metric highlight">50.45 point loss</span></li>
              <li><strong>Swift County:</strong> <span class="metric dem-highlight">D+14.20% (2008)</span> ‚Üí <span class="metric highlight">R+34.73% (2024)</span> ‚Äî <span class="metric highlight">48.93 point loss</span></li>
              <li><strong>Nobles County:</strong> <span class="metric dem-highlight">D+10.75% (2008)</span> ‚Üí <span class="metric highlight">R+36.14% (2024)</span> ‚Äî <span class="metric highlight">46.89 point loss</span></li>
            </ul>
            
            <p><strong>Geographic Scope:</strong> The rightward shift encompasses virtually all of Greater Minnesota outside the seven-county metro area. The transformation is most pronounced in:</p>
            <ul>
              <li><strong>Northwestern Minnesota:</strong> Counties like Polk, Marshall, and Roseau that were DFL strongholds through the 1990s now consistently vote Republican by 20-40 points</li>
              <li><strong>Southwestern Agricultural Belt:</strong> Redwood, Yellow Medicine, and Lyon counties show Republican margins exceeding 30 points in recent elections, compared to single-digit DFL margins in 1990</li>
              <li><strong>Central Minnesota:</strong> Morrison, Todd, and Crow Wing counties have shifted from competitive swing counties to safe Republican territory</li>
              <li><strong>Southern Tier:</strong> Traditional farming counties like Blue Earth, Faribault, and Freeborn have moved dramatically rightward since 2000</li>
            </ul>
            
            <p><strong>Key Inflection Points:</strong></p>
            <ul>
              <li><strong>1990:</strong> Arne Carlson (R) elected governor and Collin Peterson (DFL) elected to Congress (7th District) ‚Äî both would serve through the 1990s as the last generation before realignment began</li>
              <li><strong>1994:</strong> Carlson's re-election remains the last time a Republican won Minnesota's governorship by outright majority</li>
              <li><strong>1998:</strong> <span class="metric swing-highlight">Jesse Ventura's Reform Party gubernatorial victory</span> disrupted traditional DFL-Republican dynamics and signaled voter discontent with establishment politics, foreshadowing future populist movements</li>
              <li><strong>2004:</strong> First clear signs of rural erosion for DFL in presidential race, despite Kerry winning statewide</li>
              <li><strong>2010:</strong> Tea Party wave accelerated rural shift, with many historically DFL counties flipping decisively Republican</li>
              <li><strong>2016:</strong> Trump's performance in rural Minnesota exceeded previous Republican candidates by 10-15 points in many counties</li>
              <li><strong>2016-2020:</strong> Collin Peterson's margins in Minnesota's 7th District eroded dramatically in the Trump era despite his 30-year incumbency advantage</li>
              <li><strong>2020:</strong> <span class="metric highlight">Collin Peterson ousted</span> ‚Äî Defeated by former Lt. Governor Michelle Fischbach after representing rural western Minnesota since 1990, symbolizing the complete rural realignment</li>
              <li><strong>2020-2024:</strong> Consolidation of Republican dominance in rural areas, with few signs of DFL recovery</li>
            </ul>
            
            <p><strong>The Death of the Farmer-Labor Coalition:</strong></p>
            <p>The "FL" (Farmer-Labor) in DFL once represented a powerful alliance between urban union workers and rural farmers, forged in the 1944 party merger. By 2016, this coalition had collapsed completely, with DFL candidates largely confined to cities and suburbs. <strong>Amy Klobuchar</strong> remains the only statewide DFL politician maintaining significant rural appeal, continuing to win counties that vote heavily Republican in other races.</p>
            
            <p><strong>2016 Congressional Warning Signs:</strong></p>
            <ul>
              <li><strong>Tim Walz (1st District):</strong> Narrowly won re-election even as his southern Minnesota district voted for Trump. Walz, who had represented the district since 2007, recognized the erosion and ran for Governor in 2018, winning statewide but never returning to rural congressional politics. He now serves as Governor (2019-present).</li>
              <li><strong>Rick Nolan (8th District):</strong> Barely survived re-election in the Iron Range district he had represented since 2013 (and previously 1975-1981), despite his district voting heavily for Trump. Nolan retired in 2018 rather than face another difficult race. He passed away in 2022.</li>
            </ul>
            
            <p><strong>Post-2018 Republican Consolidation:</strong></p>
            <ul>
              <li><strong>1st District:</strong> Jim Hagedorn (R) won in 2018, held until his death in 2022. Brad Finstad (R) won the 2022 special election and cruised to re-election in 2024. The seat is now considered <span class="metric highlight">Safe Republican</span>.</li>
              <li><strong>8th District:</strong> Pete Stauber (R) won in 2018 and has held the seat comfortably since. The former DFL Iron Range stronghold is now <span class="metric highlight">Safe Republican</span>.</li>
            </ul>
            
            <p><strong>Historical Significance:</strong> These districts were DFL strongholds for generations. Their conversion to safe Republican seats in a single election cycle (2016-2018) demonstrates how completely the Farmer-Labor coalition has disintegrated. Modern DFL success depends entirely on overwhelming metro margins, as the party's rural "Farmer-Labor" identity exists in name only.</p>
            
            <p><strong>Socioeconomic Drivers:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Educational Polarization:</strong> Counties with lower percentages of college-educated residents have trended sharply Republican</li>
              <li><strong>Economic Anxiety:</strong> Decline of family farming, rural hospital closures, and manufacturing job losses have eroded DFL economic appeals</li>
              <li><strong>Cultural Issues:</strong> Gun rights, abortion politics, and cultural conservatism have increasingly driven rural voting patterns</li>
              <li><strong>Trade Policy:</strong> Agriculture-dependent counties became more Republican amid debates over trade agreements and tariff policies</li>
              <li><strong>Population Decline:</strong> Young people leaving rural areas for urban opportunities has concentrated older, more conservative voters in rural counties</li>
            </ul>
            
            <p><strong>Electoral Impact:</strong> The rural shift has transformed Minnesota from a state where DFL candidates could win statewide by running up margins in both metro and rural areas, to one where DFL victories depend almost entirely on overwhelming metro margins to offset rural Republican strength. This has made statewide races increasingly competitive and narrow.</p>
          </div>
          </div>

          <div class="finding-card">
            <h5>2Ô∏è‚É£ The Iron Range: A Case Study in Working-Class Realignment</h5>
            <p><strong>Historical Context:</strong> The Iron Range of northeastern Minnesota represents one of the most significant political realignments in American electoral history. From the 1930s through the 1990s, this region was among the most reliably Democratic areas in the nation, rooted in labor union strength and New Deal politics.</p>
            
            <p><strong>St. Louis County Presidential Results - The Numbers Tell the Story:</strong></p>
            <ul>
              <li><strong>2008:</strong> <span class="metric dem-highlight">D+33.26%</span> ‚Äî Dominant Democratic</li>
              <li><strong>2012:</strong> <span class="metric dem-highlight">D+30.44%</span> ‚Äî Dominant Democratic</li>
              <li><strong>2016:</strong> <span class="metric dem-highlight">D+12.83%</span> ‚Äî Safe Democratic</li>
              <li><strong>2020:</strong> <span class="metric dem-highlight">D+16.01%</span> ‚Äî Safe Democratic</li>
              <li><strong>2024:</strong> <span class="metric dem-highlight">D+13.98%</span> ‚Äî Safe Democratic</li>
            </ul>
            
            <p><strong>The Dramatic Erosion:</strong> St. Louis County's collapse from <span class="metric dem-highlight">D+33.26% (2008)</span> to <span class="metric dem-highlight">D+13.98% (2024)</span> represents a <span class="metric highlight">19.28-point loss</span> in just 16 years. This stunning erosion would have turned the county Republican if not for one critical factor: <strong>Duluth</strong>.</p>
            
            <p><strong>Geographic Divide Within the County:</strong></p>
            <ul>
              <li><strong>Duluth (Urban Core):</strong> Remains solidly Democratic at <span class="metric dem-highlight">65-70% DFL</span> in recent elections. College-educated professionals and service economy workers maintain traditional liberal voting patterns</li>
              <li><strong>Iron Range Communities:</strong> Virginia, Hibbing, Eveleth, and smaller mining towns have shifted dramatically Republican. Trump won many of these communities by <span class="metric highlight">10-15 points</span> in 2016 and 2020</li>
              <li><strong>Rural Areas:</strong> Townships and unincorporated areas show Republican margins exceeding <span class="metric highlight">30 points</span>, compared to DFL margins of similar size in the 1990s</li>
            </ul>
            
            <p><strong>Economic and Industrial Factors:</strong></p>
            <ul>
              <li><strong>Mining Industry Changes:</strong> Decline from peak employment in 1970s-80s, automation reducing workforce, environmental regulations creating tensions with traditional DFL environmental stances</li>
              <li><strong>Union Decline:</strong> Weakening of labor union power, decreased union household percentages, generational shift away from union-based political identity</li>
              <li><strong>Trade Policy Tensions:</strong> Perception that DFL/Democratic positions on trade harmed mining and manufacturing interests</li>
              <li><strong>Energy Policy Conflicts:</strong> DFL environmental positions on mining and energy production increasingly at odds with Iron Range economic interests, particularly regarding copper-nickel mining proposals</li>
            </ul>
            
            <p><strong>Demographic Shifts:</strong></p>
            <ul>
              <li><strong>Population Decline:</strong> Young people leaving for opportunities elsewhere, aging population more culturally conservative</li>
              <li><strong>Ethnic Heritage:</strong> Historically strong immigrant communities (Finnish, Italian, Slavic) that formed union base have dispersed or assimilated, weakening ethnic-based political solidarity</li>
              <li><strong>Educational Attainment:</strong> Lower college completion rates correlate with Republican shift, matching national educational polarization patterns</li>
            </ul>
            
            <p><strong>The Duluth Factor - Why St. Louis County Stays Blue:</strong> St. Louis County's sustained Democratic performance despite the Iron Range's rightward lurch can be attributed to one critical factor: <strong>Duluth</strong>. The city of Duluth (population ~86,000) represents approximately 40% of the county's population and votes overwhelmingly Democratic, typically <span class="metric dem-highlight">65-70% DFL</span> in presidential elections. Without Duluth's urban Democratic vote, the Iron Range and rural portions of St. Louis County would deliver solid Republican margins.</p>
            
            <p><strong>The Mathematics of Urban Salvation:</strong> Duluth's concentrated Democratic vote essentially cancels out Republican advantages across the vast geography of the Iron Range and rural St. Louis County. While mining towns like Virginia, Hibbing, Eveleth, and Chisholm have trended heavily Republican (many now voting <span class="metric highlight">55-65% Trump</span>), and rural townships deliver <span class="metric highlight">60-70% Republican</span> margins, Duluth generates enough absolute Democratic votes to keep the county's overall total in the DFL column. This pattern - a college-educated, diverse urban center offsetting a working-class, predominantly white hinterland - mirrors dynamics in countless American counties.</p>
            
            <p><strong>Counterfactual Analysis:</strong> If Duluth were hypothetically removed from St. Louis County's vote totals, the remainder would likely vote Republican by <span class="metric highlight">10-15 points</span> in recent elections, making it indistinguishable from neighboring rural counties. Duluth alone is the reason St. Louis County remains categorized as "Safe Democratic" rather than trending toward "Lean Republican" or worse. The city's presence prevents what would otherwise be a complete Republican takeover of northeastern Minnesota.</p>
          </div>

          <div class="finding-card">
            <h5>3Ô∏è‚É£ County Profile: Itasca County - The Quintessential Obama‚ÜíTrump Flip</h5>
            <p><strong>Geographic Context:</strong> Itasca County in north-central Minnesota, home to Grand Rapids and the headwaters of the Mississippi River, exemplifies the Obama-to-Trump voter phenomenon. This former DFL county represents the working-class realignment that reshaped American politics.</p>
            
            <p><strong>The Complete Trajectory (2008-2024):</strong></p>
            <ul>
              <li><strong>2008:</strong> <span class="metric dem-highlight">D+13.26%</span> ‚Äî Safe Democratic</li>
              <li><strong>2012:</strong> <span class="metric dem-highlight">D+10.07%</span> ‚Äî Likely Democratic</li>
              <li><strong>2016:</strong> <strong>THE FLIP:</strong> <span class="metric highlight">R+17.80%</span> ‚Äî Safe Republican</li>
              <li><strong>2020:</strong> <span class="metric highlight">R+17.11%</span> ‚Äî Safe Republican</li>
              <li><strong>2024:</strong> <span class="metric highlight">R+20.49%</span> ‚Äî Stronghold Republican</li>
            </ul>
            
            <p><strong>Total Swing Analysis:</strong> From <span class="metric dem-highlight">D+13.26% (2008)</span> to <span class="metric highlight">R+20.49% (2024)</span> represents a <span class="metric swing-highlight">33.75-point swing</span> over 16 years. The county went from voting 10 points more Democratic than the nation in 2008 to voting 15 points more Republican than the nation in 2024.</p>
            
            <p><strong>Socioeconomic Profile:</strong> Itasca County's economy centers on forestry, paper mills, tourism, and mining-related industries. The county has lower educational attainment than state averages, an aging population, and has experienced decades of economic restructuring as traditional industries declined. These factors perfectly align with the demographic groups that have realigned toward Republicans nationally.</p>
            
            <p><strong>Why Itasca Matters:</strong> Itasca County represents dozens of similar working-class, resource-extraction, and manufacturing-dependent counties across the Upper Midwest that flipped from Obama to Trump. Understanding Itasca's transformation helps explain the broader realignment that made Minnesota competitive and turned Wisconsin, Michigan, and Pennsylvania into true battlegrounds.</p>
          </div>

          <div class="finding-card">
            <h5>4Ô∏è‚É£ County Profile: Hennepin County - The Democratic Anchor</h5>
            <p><strong>The State's Political Center of Gravity:</strong> Hennepin County, home to Minneapolis and containing over 1.2 million residents (22% of Minnesota's population), has become the indispensable foundation of DFL political power. While rural Minnesota has hemorrhaged Democratic support, Hennepin has moved in the opposite direction, generating ever-larger Democratic margins.</p>
            
            <p><strong>Presidential Results - Growing Democratic Dominance (2008-2024):</strong></p>
            <ul>
              <li><strong>2008:</strong> <span class="metric dem-highlight">D+29.13%</span> (189,904 vote margin)</li>
              <li><strong>2012:</strong> <span class="metric dem-highlight">D+27.69%</span> (183,909 vote margin)</li>
              <li><strong>2016:</strong> <span class="metric dem-highlight">D+38.24%</span> (237,518 vote margin)</li>
              <li><strong>2020:</strong> <span class="metric dem-highlight">D+44.23%</span> (326,650 vote margin)</li>
              <li><strong>2024:</strong> <span class="metric dem-highlight">D+43.64%</span> (305,466 vote margin)</li>
            </ul>
            
            <p><strong>The Math That Wins Elections:</strong> Hennepin County's transformation tells a remarkable story:</p>
            <ul>
              <li>Obama's 2008 margin of 189,904 votes was already dominant at <span class="metric dem-highlight">D+29.13%</span></li>
              <li>By 2020, Biden increased the margin to <span class="metric dem-highlight">D+44.23%</span> ‚Äî a <span class="metric swing-highlight">15.10-point increase</span> in Democratic dominance</li>
              <li>The raw vote margin grew from 189,904 to 326,650 votes ‚Äî a <strong>72% increase in absolute Democratic advantage</strong></li>
              <li>Hennepin alone provided more Democratic votes in 2020 than 76 other counties combined provided Republican votes</li>
              <li>Even in 2024 when Harris received fewer votes than Biden, her 305,466-vote margin still exceeded Obama's 2008 margin by 61%</li>
            </ul>
            
            <p><strong>Geographic Patterns Within Hennepin:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Minneapolis Core:</strong> Consistently delivers 75-80% Democratic votes, with some precincts exceeding 90%. Progressive politics, young voters, diverse population, and high educational attainment create overwhelming DFL majorities.</li>
              <li><strong>Inner-Ring Suburbs:</strong> Communities like St. Louis Park (70%+ DFL), Richfield (65%+ DFL), Hopkins, and Robbinsdale have moved sharply Democratic as they've become more diverse and educated.</li>
              <li><strong>Western Suburbs - The Shift:</strong> Traditionally Republican suburbs like Edina, Minnetonka, and Eden Prairie have either flipped Democratic or become highly competitive. College-educated professionals in these affluent communities have realigned toward Democrats on social and cultural issues.</li>
              <li><strong>Remaining Republican Bases:</strong> Only the far western suburbs like Medina, Orono, and Independence maintain Republican lean, and even these have narrowed considerably.</li>
            </ul>
            
            <p><strong>Why Hennepin's Growth Matters:</strong> Democrats' increasing dominance in Hennepin represents educational polarization in its purest form. The county has the state's highest concentration of college graduates, professional employment, and secular voters - all demographics trending Democratic nationally. As long as Hennepin continues generating 300,000+ vote margins, DFL candidates can win statewide even while losing 75-80% of Minnesota's counties.</p>
          </div>

          <div class="finding-card">
            <h5>5Ô∏è‚É£ County Profile: Ramsey County - Minnesota's "Chicago Effect"</h5>
            <p><strong>Why Minnesota Isn't a Swing State:</strong> Ramsey County (St. Paul) is the answer to a critical question: Why does Minnesota remain reliably Democratic while states like Wisconsin, Arizona, North Carolina, and Georgia swing between parties? The answer lies in Ramsey County's role as Minnesota's equivalent to Cook County, Illinois (Chicago). Just as Chicago's overwhelming Democratic margins make Illinois uncompetitive despite downstate Republican dominance, St. Paul and Ramsey County provide an insurmountable Democratic firewall that keeps Minnesota blue.</p>
            
            <p><strong>Presidential Results - Consistent Democratic Fortress (2008-2024):</strong></p>
            <ul>
              <li><strong>2008:</strong> <span class="metric dem-highlight">D+34.58%</span> (100,477 vote margin)</li>
              <li><strong>2012:</strong> <span class="metric dem-highlight">D+36.11%</span> (96,138 vote margin)</li>
              <li><strong>2016:</strong> <span class="metric dem-highlight">D+42.97%</span> (114,258 vote margin)</li>
              <li><strong>2020:</strong> <span class="metric dem-highlight">D+46.45%</span> (149,244 vote margin)</li>
              <li><strong>2024:</strong> <span class="metric dem-highlight">D+44.33%</span> (130,884 vote margin)</li>
            </ul>
            
            <p><strong>Remarkable Consistency - The 100,000-Vote Democratic Floor:</strong> What makes Ramsey County extraordinary is not just that it votes heavily Democratic, but that it has provided a <strong>minimum Democratic margin of 96,000 votes in every presidential election since 2008</strong>, typically exceeding 100,000 votes. Even in Harris's 2024 performance, when Democrats underperformed compared to 2020 in many places, Ramsey still delivered 130,884 Democratic votes - a margin larger than the total population of 60 Minnesota counties combined.</p>
            
            <p><strong>The Chicago Comparison - Urban Anchors vs. Swing States:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Illinois Model (Minnesota):</strong> Chicago's Cook County provides ~1.5 million vote Democratic margins, making Illinois safe Democratic despite Republican dominance in rural Illinois. Similarly, Ramsey (130,000 margin) + Hennepin (305,000 margin) = 435,000 combined votes, making Minnesota safe Democratic despite losing 75+ counties.</li>
              <li><strong>Swing State Contrast (Wisconsin, Arizona, Georgia, North Carolina):</strong> These states lack a single dominant urban Democratic anchor large enough to offset rural Republican strength. Milwaukee, Phoenix, Atlanta, and Charlotte provide substantial Democratic margins, but not insurmountable ones. Without a "Chicago" or "St. Paul," these states remain genuinely competitive.</li>
              <li><strong>The Mathematics of Anchors:</strong> To overcome Ramsey + Hennepin's 435,000-vote firewall, Republicans would need to win the other 85 Minnesota counties by an average of over 5,000 votes each - mathematically impossible given that many Greater Minnesota counties have total populations under 10,000.</li>
            </ul>
            
            <p><strong>St. Paul's Demographic Profile - Why It Votes This Way:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Educational Attainment:</strong> Over 40% of Ramsey County residents hold bachelor's degrees or higher, correlating with strong Democratic performance</li>
              <li><strong>Racial and Ethnic Diversity:</strong> St. Paul has the nation's largest Hmong American population (~30,000), significant Black population (~15%), and growing Latino community. These communities vote 75-90% Democratic.</li>
              <li><strong>Government Employment:</strong> St. Paul is the state capital, with tens of thousands of government employees who lean Democratic</li>
              <li><strong>Educational Institutions:</strong> University of St. Thomas, Macalester College, Hamline University, and other institutions create concentrations of educated, progressive voters</li>
              <li><strong>Urban Culture:</strong> As a major urban center, St. Paul embodies cosmopolitan, diverse, secular culture that aligns with Democratic positions on social issues</li>
            </ul>
            
            <p><strong>Geographic Breakdown Within Ramsey:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>St. Paul Proper:</strong> The city votes 70-75% Democratic in presidential elections, similar to Minneapolis. Some precincts in heavily Hmong or Black neighborhoods exceed 85-90% Democratic.</li>
              <li><strong>Inner-Ring Suburbs:</strong> Communities like Maplewood, North St. Paul, Little Canada, and Roseville consistently vote 55-65% Democratic, providing solid supplementary margins to the St. Paul core.</li>
              <li><strong>No Republican Bases:</strong> Unlike Hennepin County which has some affluent western suburbs that still lean Republican, Ramsey County has virtually no geographic Republican strongholds. Even the most conservative precincts typically vote only 40-45% Republican.</li>
            </ul>
            
            <p><strong>Why This Matters for Minnesota's Future:</strong> As long as Ramsey County continues providing 100,000+ vote Democratic margins (and it has done so for 16+ years with no signs of weakening), Minnesota will remain a Safe Democratic state in presidential elections. Combined with Hennepin's even larger margins, the Twin Cities core creates a firewall that rural Republican dominance cannot overcome. This is why Minnesota resembles Illinois (reliably blue despite rural red) rather than Wisconsin (genuine swing state). <strong>Ramsey County IS Minnesota's Chicago</strong> - and that single fact explains why the state hasn't voted Republican for president since 1972.</p>
          </div>

          <div class="finding-card">
            <h5>6Ô∏è‚É£ County Profile: Dakota County - The Suburban Bellwether</h5>
            <p><strong>Minnesota's Most Competitive County:</strong> Dakota County, the third-most populous county with 440,000 residents, represents the new American political battleground: diverse, educated, economically mixed suburbs where neither party has a structural advantage. It contains affluent tech workers, working-class service employees, longtime residents, and new immigrants - a microcosm of suburban America.</p>
            
            <p><strong>Presidential Results - The Suburban Tug-of-War (2008-2024):</strong></p>
            <ul>
              <li><strong>2008:</strong> <span class="metric dem-highlight">D+5.61%</span> ‚Äî Likely Democratic</li>
              <li><strong>2012:</strong> <span class="metric dem-highlight">D+2.98%</span> ‚Äî Lean Democratic</li>
              <li><strong>2016:</strong> <span class="metric dem-highlight">D+5.19%</span> ‚Äî Likely Democratic</li>
              <li><strong>2020:</strong> <span class="metric dem-highlight">D+14.28%</span> ‚Äî Safe Democratic</li>
              <li><strong>2024:</strong> <span class="metric dem-highlight">D+13.14%</span> ‚Äî Safe Democratic</li>
            </ul>
            
            <p><strong>The 2020 Inflection Point:</strong> Dakota County's transformation is most visible in the stark difference between <span class="metric dem-highlight">D+5.19% (2016)</span> and <span class="metric dem-highlight">D+14.28% (2020)</span>. This <span class="metric swing-highlight">9.09-point surge</span> represents the suburban realignment against Trump that defined the 2020 election:</p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li>College-educated suburban voters, particularly women, moved decisively toward Democrats</li>
              <li>Even working-class suburbs like West St. Paul showed modest Democratic gains</li>
              <li>Affluent communities like Eagan and Apple Valley that once leaned Republican became solidly Democratic</li>
              <li>The county's growing diversity (Asian American, Latino, East African populations) strengthened DFL margins</li>
            </ul>
            
            <p><strong>Internal Geography - A County Divided:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Northern Communities:</strong> West St. Paul, South St. Paul, Inver Grove Heights - working-class suburbs with strong union presence, trending more Democratic</li>
              <li><strong>Central/Eastern Cities:</strong> Eagan, Apple Valley, Burnsville - large, diverse suburbs that have become Democratic-leaning as they've grown and diversified</li>
              <li><strong>Southern/Rural Areas:</strong> Farmington, Lakeville (southern portions), and rural townships maintain Republican lean but with narrowing margins</li>
            </ul>
            
            <p><strong>Dakota as Electoral Indicator:</strong> Dakota County's role as a bellwether cannot be overstated. In close statewide Minnesota races, Dakota often determines the outcome. When Democrats win Dakota by double digits (as in 2020-2024), they win statewide comfortably. When Dakota is close (as in 2012), statewide races are nail-biters. The county's competitive nature means campaigns invest heavily here, making it one of the most politically engaged counties in the state.</p>
          </div>

          <div class="finding-card">
            <h5>7Ô∏è‚É£ Twin Cities Metro: The Democratic Firewall</h5>
            <p><strong>Metropolitan Overview:</strong> The seven-county Twin Cities metropolitan area (Hennepin, Ramsey, Dakota, Washington, Anoka, Carver, Scott) has become the essential foundation for DFL statewide victories. The metro area contains over 60% of Minnesota's population and generates even larger percentages of DFL vote margins.</p>
            
            <p><strong>Core Counties - Democratic Strongholds:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Hennepin County (Minneapolis):</strong> The state's most populous county consistently delivers DFL margins of 200,000-300,000 votes in major elections. Minneapolis proper votes 70-80% Democratic, while inner-ring suburbs like St. Louis Park, Richfield, and Edina have trended increasingly Democratic. Even traditionally Republican western suburbs like Minnetonka and Eden Prairie have become competitive or lean Democratic in recent cycles.</li>
              <li><strong>Ramsey County (St. Paul):</strong> Provides 60,000-100,000 vote DFL margins. St. Paul votes similarly to Minneapolis (70-80% Democratic), while inner-ring suburbs remain reliably blue. The county's diverse population and government employment concentration reinforce Democratic voting patterns.</li>
            </ul>
            
            <p><strong>Suburban Battlegrounds:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Dakota County (Southern Suburbs):</strong> The most competitive metro county, swinging between parties in close elections. Contains mix of working-class suburbs (West St. Paul, South St. Paul) and affluent communities (Eagan, Apple Valley). College-educated voters have moved Democratic, while non-college voters trend Republican, creating intense competition.</li>
              <li><strong>Washington County (Eastern Suburbs):</strong> Historically Republican, now competitive in close statewide races. Woodbury, Cottage Grove, and Stillwater show signs of suburban realignment toward Democrats among college-educated professionals.</li>
              <li><strong>Anoka County (Northern Suburbs):</strong> Working-class suburbs with lower educational attainment levels, remains Republican-leaning but closer than in previous decades. Contains bellwether communities like Blaine and Coon Rapids.</li>
              <li><strong>Carver County (Southwest Exurbs):</strong> Affluent, rapidly growing exurban county that remains Republican but with narrowing margins in communities like Chanhassen and Chaska as college-educated voters trend Democratic.</li>
              <li><strong>Scott County (Southern Exurbs):</strong> Similar to Carver, rapidly growing and Republican-leaning, but showing slight moderation in presidential races as population diversifies.</li>
            </ul>
            
            <p><strong>Demographic Trends Favoring Democrats:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Educational Attainment:</strong> High percentages of college graduates, particularly in Hennepin and Ramsey counties, align with national trends of educated voters moving Democratic</li>
              <li><strong>Racial and Ethnic Diversity:</strong> Growing populations of Black, Somali, Hmong, Latino, and South Asian residents who vote heavily Democratic</li>
              <li><strong>Age Demographics:</strong> Younger voters concentrated in metro area, particularly Minneapolis and St. Paul, lean strongly Democratic</li>
              <li><strong>Professional Employment:</strong> High concentration of white-collar professional jobs in healthcare, technology, finance, and education sectors that correlate with Democratic voting</li>
              <li><strong>Secular Trends:</strong> Higher percentages of religiously unaffiliated voters who tend to support Democrats on social issues</li>
            </ul>
            
            <p><strong>Offsetting Rural Losses:</strong> To win statewide, DFL candidates must generate massive metro margins to overcome rural deficits. In 2020, Biden won Minnesota by 233,012 votes, but lost 76 of 87 counties. His metro margins, led by Hennepin's 290,000-vote advantage, were large enough to overcome losing Greater Minnesota by substantial margins. This pattern has become the new normal for DFL statewide victories.</p>
            
            <p><strong>Future Trajectory:</strong> The metro continues to grow while rural Minnesota shrinks in population, potentially advantaging Democrats in the long term. However, if suburban Republican-leaning counties like Anoka, Carver, and Scott grow faster than core Democratic counties, this could offset the overall metro advantage.</p>
          </div>

          <div class="finding-card">
            <h5>8Ô∏è‚É£ Critical Elections and Turning Points (1990-2024)</h5>
            
            <p><strong>1990 Senate Race - Wellstone's Victory:</strong> Paul Wellstone's upset victory over incumbent Republican Rudy Boschwitz established the progressive populist model that would define Minnesota DFL politics for decades. Wellstone combined metro liberal support with rural populist appeals on economic issues, showing that progressive candidates could still win in Greater Minnesota.</p>
            
            <p><strong>1998 Gubernatorial Election - The Ventura Phenomenon:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Three-Way Race:</strong> Jesse Ventura (Reform Party) defeated Republican Norm Coleman and DFL's Hubert H. Humphrey III in a stunning upset</li>
              <li><strong>Electoral Impact:</strong> Ventura won by mobilizing non-traditional voters and independents, demonstrating Minnesota's third-party openness</li>
              <li><strong>Geographic Coalition:</strong> Combined rural populist appeal with suburban independent voters, a coalition that would foreshadow future Republican rural success</li>
              <li><strong>Legacy:</strong> Showed that traditional DFL rural dominance was vulnerable to anti-establishment appeals</li>
            </ul>
            
            <p><strong>2002 Senate Race - Wellstone's Death and Mondale's Loss:</strong> Paul Wellstone died in a plane crash 11 days before the 2002 election. Former Vice President Walter Mondale replaced him on the ballot but lost narrowly to Republican Norm Coleman. The emotional memorial service was criticized as too political, potentially costing Mondale swing voters. This marked a turning point in Minnesota Senate representation, with Republicans holding the seat until 2006.</p>
            
            <p><strong>2008 Senate Race - Franken-Coleman Recount:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Closest Race in Minnesota History:</strong> Al Franken defeated Norm Coleman by just 312 votes after an eight-month recount and legal battle</li>
              <li><strong>Geographic Pattern:</strong> Coleman dominated rural Minnesota, Franken won with massive margins in Hennepin and Ramsey counties</li>
              <li><strong>Third-Party Impact:</strong> Independence Party candidate Dean Barkley won 15% of the vote, affecting the outcome</li>
              <li><strong>Significance:</strong> Demonstrated how narrow the margin between parties had become despite DFL statewide success</li>
            </ul>
            
            <p><strong>2010 Gubernatorial Election - Dayton's Narrow Win:</strong> Mark Dayton won the governorship by just 0.4% (8,770 votes) in a three-way race, benefiting from third-party candidate Tom Horner taking 12% of the vote, primarily from moderate Republicans. This extremely narrow margin foreshadowed how competitive statewide races would become in the 2010s.</p>
            
            <p><strong>2016 Presidential Election - Trump's Rural Breakthrough:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Clinton's Narrow Win:</strong> Hillary Clinton won Minnesota by just 1.5%, the closest Democratic presidential victory since 1984</li>
              <li><strong>Rural Collapse:</strong> Clinton lost rural counties by unprecedented margins, even compared to previous Republican candidates</li>
              <li><strong>Iron Range Shift:</strong> Trump dramatically outperformed previous Republicans in St. Louis County and the Iron Range</li>
              <li><strong>Electoral Warning:</strong> Minnesota came closer to voting Republican for president than at any time since 1972</li>
            </ul>
            
            <p><strong>2020 Presidential Election - Rural-Metro Polarization Peaks:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Biden's Recovery:</strong> Joe Biden won Minnesota by 7.1%, a significant improvement over Clinton but still narrow by historical standards</li>
              <li><strong>Geographic Extremes:</strong> Biden won only 11 of 87 counties but generated massive margins in Hennepin (290,000 votes) and Ramsey (113,000 votes)</li>
              <li><strong>Rural Defection Complete:</strong> Biden lost Greater Minnesota overall by approximately 200,000 votes, offset entirely by metro performance</li>
              <li><strong>Class Polarization:</strong> Clearest evidence yet of education-based voting, with college-educated suburbs moving Democratic and working-class rural areas moving Republican</li>
            </ul>
            
            <p><strong>2022 Midterm Elections - DFL Statewide Sweep:</strong> Despite Republican rural strength, DFL candidates won governor, attorney general, secretary of state, and state auditor races, showing the metro firewall remains sufficient for statewide victories. However, margins remained narrow in most races, typically 5-7 points, significantly closer than DFL margins in the 1990s and early 2000s.</p>
          </div>

          <div class="finding-card">
            <h5>9Ô∏è‚É£ Demographic and Sociological Factors</h5>
            
            <p><strong>Educational Polarization - The Defining Factor:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>College-Educated Voters:</strong> Voters with bachelor's degrees or higher have moved sharply Democratic across all regions. Even historically Republican suburbs with high education levels (Edina, Minnetonka, Woodbury) have trended Democratic.</li>
              <li><strong>Non-College Voters:</strong> Voters without four-year degrees have moved Republican, especially in rural areas and working-class suburbs. This realignment cuts across traditional racial and ethnic lines.</li>
              <li><strong>Geographic Correlation:</strong> Counties with university presence (St. Louis-Duluth, Blue Earth-Mankato, Stearns-St. Cloud) show more Democratic strength than similar-sized counties without higher education institutions.</li>
              <li><strong>Generational Impact:</strong> Younger voters with college educations strongly favor Democrats, while older non-college voters increasingly support Republicans.</li>
            </ul>
            
            <p><strong>Racial and Ethnic Diversity:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Twin Cities Diversity:</strong> Hennepin and Ramsey counties have significant Black (primarily in Minneapolis and St. Paul), Hmong (St. Paul), Somali (Minneapolis), and Latino populations that vote heavily Democratic (typically 75-90% DFL)</li>
              <li><strong>Rural Homogeneity:</strong> Most Greater Minnesota counties remain over 90% white, with limited racial diversity contributing to cultural conservatism and Republican voting patterns</li>
              <li><strong>Suburban Diversification:</strong> Inner-ring suburbs becoming more diverse (Richfield, Columbia Heights, Brooklyn Center), contributing to Democratic shifts in these communities</li>
              <li><strong>Immigration Impact:</strong> Recent immigrant communities, particularly Somali and Hmong populations, provide reliable Democratic votes but face political mobilization challenges</li>
            </ul>
            
            <p><strong>Religious and Cultural Factors:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Secular Twin Cities:</strong> Minneapolis and St. Paul have high percentages of religiously unaffiliated residents who lean Democratic on social and cultural issues</li>
              <li><strong>Evangelical Rural Areas:</strong> Growth of evangelical Protestant churches in rural Minnesota correlates with Republican voting strength</li>
              <li><strong>Catholic Realignment:</strong> Historic Catholic DFL support (rooted in immigrant communities) has weakened as abortion becomes more salient. Rural Catholic areas increasingly vote Republican.</li>
              <li><strong>Lutheran Tradition:</strong> Minnesota's Lutheran heritage historically correlated with moderate politics, but Lutheran communities have polarized along urban-rural and education lines</li>
            </ul>
            
            <p><strong>Economic and Class Factors:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Income Polarization:</strong> High-income professional class in metro areas votes Democratic, while middle and working-class rural voters support Republicans</li>
              <li><strong>Industry Employment:</strong> Manufacturing and agriculture workers increasingly Republican; government employees, educators, and healthcare workers increasingly Democratic</li>
              <li><strong>Union Decline:</strong> Minnesota's once-powerful labor movement has weakened significantly since the 1990s. Union household percentage has dropped from ~30% to ~15%, weakening traditional DFL labor base</li>
              <li><strong>Economic Anxiety:</strong> Rural economic decline (farm consolidation, manufacturing losses, retail closures) drives cultural resentment and Republican voting</li>
            </ul>
            
            <p><strong>Age and Generational Dynamics:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Youth Concentration:</strong> Voters under 35 heavily concentrated in Twin Cities metro, vote strongly Democratic (60-70% DFL)</li>
              <li><strong>Rural Aging:</strong> Greater Minnesota has higher median ages, older voters more likely to support Republicans</li>
              <li><strong>Generational Migration:</strong> Young people leaving rural areas for metro opportunities creates self-reinforcing polarization cycle</li>
              <li><strong>Senior Voting Patterns:</strong> Older voters increasingly Republican in rural areas, but more mixed in metro areas where education levels are higher</li>
            </ul>
          </div>

          <div class="finding-card">
            <h5>üîü Future Trajectory and Competitive Balance</h5>
            
            <p><strong>Population Trends Reshaping the Map:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Metro Growth:</strong> The seven-county metro area continues growing as percentage of state population. If current trends continue, the metro could exceed 65% of state population by 2030, potentially offsetting rural Republican strength.</li>
              <li><strong>Rural Decline:</strong> 56 of Minnesota's 87 counties lost population between 2010-2020. This demographic hemorrhaging weakens rural electoral influence despite increased Republican voting percentages.</li>
              <li><strong>Suburban Expansion:</strong> Fastest-growing areas are outer-ring suburbs and exurbs (Carver, Scott, Wright counties), which lean Republican but less so than rural areas. Their growth could determine Minnesota's political future.</li>
              <li><strong>Urban Density:</strong> Minneapolis and St. Paul continue modest growth while becoming denser, concentrating Democratic votes more efficiently.</li>
            </ul>
            
            <p><strong>Electoral Math Going Forward:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>DFL Path to Victory:</strong> Democrats must win Hennepin County by 250,000+ votes, Ramsey by 100,000+, and keep suburban counties competitive while minimizing rural losses. This formula worked in 2018, 2020, and 2022.</li>
              <li><strong>Republican Path to Victory:</strong> Republicans need to maximize rural turnout and margins while keeping Hennepin margins under 200,000 and winning at least 3-4 of the 5 suburban counties. They came close to this in 2016.</li>
              <li><strong>Swing County Importance:</strong> Dakota, Washington, and Anoka counties increasingly determine statewide outcomes. Small shifts in these populous suburban counties can swing entire elections.</li>
              <li><strong>Third-Party Wildcard:</strong> Minnesota's history with third-party candidates (Perot 1992, Ventura 1998, Barkley 2008) means close races could be influenced by minor party candidates drawing votes from major party nominees.</li>
            </ul>
            
            <p><strong>Issue Environment and Polarization:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Cultural Issues Dominate:</strong> Abortion, gun rights, LGBTQ issues, and racial justice have become more salient than traditional economic issues, intensifying urban-rural polarization</li>
              <li><strong>Environmental Debates:</strong> Mining, energy policy, and climate change create particular tensions in Minnesota, where economic and environmental interests clash</li>
              <li><strong>Crime and Public Safety:</strong> Urban crime concerns in Minneapolis-St. Paul provide Republican opening in metro areas, though effect limited by education polarization</li>
              <li><strong>Immigration:</strong> While less salient than in border states, immigration policy debates affect Minnesota's diverse metro areas and influence rural cultural conservatism</li>
            </ul>
            
            <p><strong>Scenario Analysis - Minnesota in 2026 and Beyond:</strong></p>
            <ul style="margin: 8px 0; padding-left: 24px;">
              <li><strong>Continued DFL Advantage Scenario:</strong> If metro growth continues and college education polarization intensifies, Democrats could expand their statewide margins back to pre-2010 levels (8-12 points). Requires maintaining current metro performance while suburban counties continue trending Democratic.</li>
              <li><strong>Competitive Equilibrium Scenario:</strong> Minnesota remains a true battleground with statewide margins of 3-7 points. Rural Republican strength offsets metro Democratic advantages. Elections determined by turnout and candidate quality. Most likely scenario based on current trends.</li>
              <li><strong>Republican Breakthrough Scenario:</strong> If suburban counties like Dakota and Washington consolidate Republican lean, or if metro turnout drops while rural turnout increases, Republicans could win statewide elections more regularly. Would require reversing current education polarization trends or finding candidates who appeal to college-educated suburbanites.</li>
            </ul>
            
            <p><strong>Comparative Context:</strong> Minnesota's political evolution mirrors broader Upper Midwest trends in Wisconsin and Michigan, where metro areas provide Democratic strength while rural areas trend Republican. However, Minnesota's larger metro area percentage and unique DFL tradition have kept the state more reliably Democratic than its neighbors. Understanding Minnesota's electoral dynamics provides insight into regional political realignment across the industrial Midwest.</p>
          </div>
        </div>
      </div>
      <div class="sidebar-footer" style="padding: 16px 0; text-align: center; color: #888; font-size: 15px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
        Created by Shamar Davis
      </div>
    </div>
  <!-- Floating Sidebar Expand/Collapse Button (smaller size) -->
  <button id="sidebar-float-toggle" title="Expand Sidebar">+</button>

  <!-- Floating Status Panel -->
  <div class="status-panel" id="status-panel" style="display:none;position:fixed;top:20px;right:90px;z-index:10002;background:rgba(255,255,255,0.97);backdrop-filter:blur(10px);padding:18px 24px 18px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.12);border:1px solid #e5e7eb;max-width:340px;min-width:200px;font-size:15px;color:#34495e;">
    <span id="status-message"></span>
    <button id="status-exit" title="Close" style="position:absolute;top:10px;right:10px;padding:4px 10px;border-radius:6px;border:none;background:#eee;cursor:pointer;font-weight:bold;font-size:18px;">√ó</button>
  </div>
    


    <!-- Main Controls Dropdown (Contest Selector) -->
    <div class="main-controls" id="main-controls">
        <div class="controls-header" style="display:flex;align-items:center;justify-content:space-between;">
            <h3>üó≥Ô∏è Minnesota Election Contests</h3>
            <div style="display:flex;align-items:center;gap:8px;">
              <button class="minimize-btn" onclick="toggleMainControls()" id="controls-minimize-btn">‚àí</button>
            </div>
        </div>
        <div class="controls-content" id="controls-content">
            <div class="control-group">
                <div style="display:flex;align-items:center;gap:8px;">
                  <label>üìä Contest Type:</label>
                  <button id="accessibility-toggle" title="Accessibility: Color Blind Mode" style="background:#1f2937;color:#fff;border-radius:50%;width:32px;height:32px;border:none;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;">‚ôø</button>
                  <button id="labels-toggle" title="Toggle County Labels" style="background:#1f2937;color:#fff;border-radius:50%;width:32px;height:32px;border:none;box-shadow:0 2px 8px rgba(0,0,0,0.10);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;">üè∑Ô∏è</button>
                </div>
                <select id="contestSelect">
                    <option value="">Select a Contest...</option>
                </select>
            </div>
        </div>
    </div>

  <!-- Duplicate sidebar removed to fix HTML errors -->

    <!-- Legend -->
    <div class="legend" id="legend">
        <div class="legend-header">
            <h4>Political Categories</h4>
            <button class="minimize-btn" onclick="toggleLegend()" id="legend-minimize-btn">‚àí</button>
        </div>
        <div class="legend-content" id="legend-content">
            <div class="legend-item"><div class="legend-color" style="background: #67000d;"></div>Annihilation Republican (‚â•40.00%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #a50f15;"></div>Dominant Republican (30.00-39.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #cb181d;"></div>Stronghold Republican (20.00-29.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #ef3b2c;"></div>Safe Republican (10.00-19.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fb6a4a;"></div>Likely Republican (5.50-9.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fcae91;"></div>Lean Republican (1.00-5.49%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #fee8c8;"></div>Tilt Republican (0.50-0.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #f7f7f7; border: 1px solid #999;"></div>Tossup (<0.50%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #e1f5fe;"></div>Tilt Democratic (0.50-0.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #c6dbef;"></div>Lean Democratic (1.00-5.49%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #9ecae1;"></div>Likely Democratic (5.50-9.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #6baed6;"></div>Safe Democratic (10.00-19.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #3182bd;"></div>Stronghold Democratic (20.00-29.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #08519c;"></div>Dominant Democratic (30.00-39.99%)</div>
            <div class="legend-item"><div class="legend-color" style="background: #08306b;"></div>Annihilation Democratic (‚â•40.00%)</div>
        </div>
    </div>



    <script>
    // --- CONFIG ---
    const CONFIG = {
      mapboxToken: 'pk.eyJ1Ijoic2hhbWFyZGF2aXMiLCJhIjoiY21kcW8yeDB2MDhvbTJzb29qeGp1aDZmZCJ9.Zw_i6U-dL7_bEKRHTUh7yg',
      paths: {
        counties: './data/tl_2020_27_county20.geojson',
        election: './data/mn_elections_aggregated.json'
      },
      center: [-94.5, 46.5],
      zoom: 6,
      fitBounds: [[-97.5, 43.5], [-89.5, 49.5]]
    };

    mapboxgl.accessToken = CONFIG.mapboxToken;

    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/streets-v12', center: CONFIG.center, zoom: CONFIG.zoom });

    let electionDataJSON = null; // New JSON structure from mn_elections_aggregated.json
    let electionData = null; // Flattened array for compatibility
    let districtsInfo = null;
    let stateHouseInfo = null;
    let stateSenateInfo = null;
    let countyNameMap = {};
    let currentView = 'counties'; // 'counties', 'districts', 'state_house', 'state_senate'
    let currentElectionResults = null; // Current contest results for county details


    function setStatus(text, timeout = 4000) {
      const panel = document.getElementById('status-panel');
      const msg = document.getElementById('status-message');
      if (!panel || !msg) return;
      // Only log status messages to the console; do not show the floating status panel
      console.log(text);
    }

    async function loadJSON(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(`${path} fetch failed: ${r.status}`);
      return r.json();
    }

    async function loadCSV(path) {
      const r = await fetch(path);
      if (!r.ok) throw new Error(`${path} fetch failed: ${r.status}`);
      return r.text();
    }

    function parseCSV(csvText) {
      try {
        const result = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });
        if (result.errors.length) {
          setStatus('CSV Parse Error: ' + result.errors.map(e => e.message).join('; '));
          console.error(result.errors);
        }
        return result.data;
      } catch (err) {
        setStatus('CSV Parse Exception: ' + err.message);
        console.error(err);
        return [];
      }
    }

    // Flatten the new JSON structure into array format for compatibility
    function flattenElectionJSON(jsonData) {
      const recordsMap = {}; // Map by "year|county" to merge office types
      const results = jsonData.results_by_year || {};
      
      Object.keys(results).forEach(year => {
        const yearData = results[year];
        
        Object.keys(yearData).forEach(officeType => {
          const contests = yearData[officeType];
          
          // Map office type to match what the UI expects
          const officeTypeMap = {
            'presidential': 'president',
            'governor': 'governor',
            'us_senate': 'us_senate',
            'us_senate_special': 'us_senate_special',
            'attorney_general': 'attorney_general',
            'cfo': 'cfo',
            'agriculture_commissioner': 'agriculture_commissioner'
          };
          const mappedOfficeType = officeTypeMap[officeType] || officeType;
          
          Object.keys(contests).forEach(contestKey => {
            const contest = contests[contestKey];
            const countyResults = contest.results || {};
            
            Object.keys(countyResults).forEach(countyName => {
              const countyData = countyResults[countyName];
              const key = `${year}|${countyName}`;
              
              // Get or create the record for this year/county combo
              if (!recordsMap[key]) {
                recordsMap[key] = {
                  year: parseInt(year),
                  county: countyName
                };
              }
              
              // Add this office type's data to the record
              recordsMap[key][`${mappedOfficeType}_dem`] = countyData.dem_votes || 0;
              recordsMap[key][`${mappedOfficeType}_rep`] = countyData.rep_votes || 0;
              recordsMap[key][`${mappedOfficeType}_other`] = countyData.other_votes || 0;
              recordsMap[key][`${mappedOfficeType}_total`] = countyData.total_votes || 0;
              recordsMap[key][`${mappedOfficeType}_dem_candidate`] = countyData.dem_candidate || '';
              recordsMap[key][`${mappedOfficeType}_rep_candidate`] = countyData.rep_candidate || '';
              recordsMap[key][`${mappedOfficeType}_margin`] = countyData.margin || 0;
              recordsMap[key][`${mappedOfficeType}_margin_pct`] = countyData.margin_pct || 0;
              recordsMap[key][`${mappedOfficeType}_winner`] = countyData.winner || '';
            });
          });
        });
      });
      
      // Convert map to array
      return Object.values(recordsMap);
    }

    // Get candidate name from the JSON data (already includes first/last names)
    function getCandidateName(year, office, party) {
      if (!electionData || electionData.length === 0) return party === 'Democrat' ? 'D' : 'R';
      
      // Map office name to office type key (matching flattened data field names)
      const officeMap = {
        'President of the United States': 'president',
        'Governor': 'governor',
        'United States Senator': 'us_senate',
        'United States Senator (Special Election)': 'us_senate_special',
        'Attorney General': 'attorney_general',
        'Chief Financial Officer': 'cfo',
        'Commissioner of Agriculture': 'agriculture_commissioner'
      };
      
      const officeType = officeMap[office] || office.toLowerCase().replace(/ /g, '_');
      const partyKey = party === 'Democrat' ? 'dem' : 'rep';
      const candidateField = `${officeType}_${partyKey}_candidate`;
      
      // Find any county record for this year/office and get the candidate name
      const record = electionData.find(r => r.year == year && r[candidateField]);
      
      console.log(`DEBUG getCandidateName: year=${year}, office=${office}, party=${party}, candidateField=${candidateField}, found=${record ? record[candidateField] : 'NOT FOUND'}`);
      
      if (record && record[candidateField]) {
        return record[candidateField];
      }
      
      return party === 'Democrat' ? 'D' : 'R';
    }
// Merge JSONs (e.g., boundaries + election results)
function mergeGeoElectionData(boundaryGeoJSON, electionData, countyKey='County', countyNameKey='county') {
  // Returns a new GeoJSON with election results merged into feature properties
  if (!boundaryGeoJSON || !boundaryGeoJSON.features || !electionData) return boundaryGeoJSON;
  const electionMap = {};
  function normalizeCountyName(name) {
    return (name || '')
      .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
      .replace(/\s+/g, ' ')
      .trim()
      .toUpperCase();
  }
  electionData.forEach(row => {
    let name = normalizeCountyName(row[countyNameKey]);
    electionMap[name] = row;
  });
  boundaryGeoJSON.features.forEach(f => {
    const p = f.properties || {};
    let name = normalizeCountyName(p[countyKey] || p.NAME20 || p.COUNTYNAME || p.NAME || p.County || p.name || '');
    const electionRow = electionMap[name];
    if (electionRow) {
      Object.assign(f.properties, electionRow);
    }
  });
  return boundaryGeoJSON;
}

    function buildCountyNameMapFromGeoJSON(geojson) {
      const map = {};
      if (!geojson || !geojson.features) return map;
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      geojson.features.forEach(f => {
        const p = f.properties || {};
        const name = normalizeCountyName(p.NAME20 || p.COUNTYNAME || p.NAME || p.County || p.name || p.NAMELSAD || '');
        if (name) map[name] = name;
      });
      return map;
    }

    function formatContestName(contestType, year) {
      const nameMap = {
        'president': 'President of the United States',
        'governor': 'Governor', 
        'us_senate': 'United States Senator',
        'us_senate_special': 'United States Senator (Special Election)',
        'secretary_of_state': 'Secretary of State',
        'attorney_general': 'Attorney General',
        'state_auditor': 'State Auditor',
        'us_house': 'US House',
        'state_senate': 'State Senate',
        'state_house': 'State House',
        'gov': 'Governor',
        'pre': 'President of the United States', 
        'uss': 'United States Senator',
        'usr': 'US Representative',
        'agr': 'Commissioner of Agriculture',
        'atg': 'Attorney General',
        'cfo': 'Chief Financial Officer',
        'str': 'State Representative',
        'sts': 'State Senator',
        'ctj': 'Circuit Judge',
        'sta': 'State Attorney',
        'pub': 'Public Defender',
        'sc1': 'Supreme Court Justice',
        'sc2': 'Supreme Court Justice',
        'sc3': 'Supreme Court Justice',
        'sc4': 'Supreme Court Justice',
        'sc5': 'Supreme Court Justice'
      };
      
      if (contestType.startsWith('a') && contestType.length <= 3) {
        return `Amendment ${contestType.substring(1).toUpperCase()}`;
      }
      
      if (contestType.startsWith('d')) {
        return `Judicial Retention ${contestType.toUpperCase()}`;
      }
      
      return nameMap[contestType] || contestType.toUpperCase();
    }

    function populateContestSelectFromElectionJSON(electionData) {
      const sel = document.getElementById('contestSelect');
      sel.innerHTML = '<option value="">Select a contest...</option>';
      
      // Use only non-gerrymandered statewide contests for all views
      populateContestSelectFromCSV(electionData);
    }

    function populateContestSelectFromCSV(csvData) {
      const sel = document.getElementById('contestSelect');
      if (sel.dataset.populated === 'true') return; // Only populate once per data load
      sel.innerHTML = '<option value="">Select a contest...</option>';
      // Show loading spinner
      var spinner = document.getElementById('contest-loading-spinner');
      if (!spinner) {
        spinner = document.createElement('span');
        spinner.id = 'contest-loading-spinner';
        spinner.className = 'spinner';
        spinner.style.marginLeft = '8px';
        spinner.innerHTML = '<svg width="18" height="18" viewBox="0 0 50 50"><circle cx="25" cy="25" r="20" fill="none" stroke="#2563eb" stroke-width="5" stroke-linecap="round" stroke-dasharray="31.4 31.4" transform="rotate(-90 25 25)"/></svg>';
        sel.parentNode.insertBefore(spinner, sel.nextSibling);
      }
      const contestTypes = ['president', 'us_senate', 'us_senate_special', 'governor', 'secretary_of_state', 'attorney_general', 'state_auditor'];
      // Precompute contest/year pairs in a single pass
      const contestYearPairs = {};
      csvData.forEach(row => {
        contestTypes.forEach(contestType => {
          if (row[`${contestType}_total`] > 0) {
            if (!contestYearPairs[contestType]) contestYearPairs[contestType] = new Set();
            contestYearPairs[contestType].add(row.year);
          }
        });
      });
      // Build options with optgroups
      const fragment = document.createDocumentFragment();
      const officeGroups = {
        'president': 'Presidential Elections',
        'governor': 'Gubernatorial Elections',
        'us_senate': 'U.S. Senate Elections',
        'us_senate_special': 'U.S. Senate Special Elections',
        'secretary_of_state': 'Secretary of State Elections',
        'attorney_general': 'Attorney General Elections',
        'state_auditor': 'State Auditor Elections'
      };
      
      contestTypes.forEach(contestType => {
        if (!contestYearPairs[contestType]) return;
        const years = Array.from(contestYearPairs[contestType]).sort();
        
        // Create optgroup for this contest type
        const optgroup = document.createElement('optgroup');
        optgroup.label = officeGroups[contestType] || formatContestName(contestType, '');
        
        years.forEach(year => {
          if (contestType === 'governor' && year == 2020) return;
          const opt = document.createElement('option');
          opt.value = `${contestType}_${year}`;
          opt.textContent = `${formatContestName(contestType, year)} (${year})`;
          optgroup.appendChild(opt);
        });
        
        fragment.appendChild(optgroup);
      });
      
      sel.appendChild(fragment);
      sel.dataset.populated = 'true';
      // Hide loading spinner
  var spinner = document.getElementById('contest-loading-spinner');
  if (spinner) spinner.style.display = 'none';
      sel.onchange = () => {
        // Always use applyContest - it will check for colorblind mode automatically
        applyContest(sel.value);
        // Explicitly update sidebar for last selected county
        if (typeof lastSelectedCounty !== 'undefined' && lastSelectedCounty) {
          showCountyDetails(lastSelectedCounty);
        }
      };

    }

    function populateContestSelectForStateHouse(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.state_house_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `state_house_${year}`;
          opt.textContent = `${formatContestName('state_house', year)} (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function populateContestSelectForStateSenate(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.state_senate_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `state_senate_${year}`;
          opt.textContent = `${formatContestName('state_senate', year)} (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function populateContestSelectFromCongressionalCSV(csvData) {
      const sel = document.getElementById('contestSelect');
      const years = [...new Set(csvData.map(row => row.year))].sort();
      
      years.forEach(year => {
        const hasData = csvData.some(row => 
          row.year == year && row.us_house_total > 0
        );
        
        if (hasData) {
          const opt = document.createElement('option');
          opt.value = `us_house_${year}`;
          opt.textContent = `${formatContestName('us_house', year)} (${year})`;
          sel.appendChild(opt);
        }
      });
      sel.onchange = () => { applyContest(sel.value); };
    }

    function setAnalysisMode(mode) {
      // Update button states
      document.getElementById('county-mode').classList.toggle('active', mode === 'county');
      document.getElementById('district-mode').classList.toggle('active', mode === 'district');
      
      // Could add different analysis modes here (e.g., demographic analysis vs electoral analysis)
      console.log(`Analysis mode set to: ${mode}`);
    }

    function updateStatewideResults(contestType, year, demVotes, repVotes, totalVotes) {
      const statewideContent = document.getElementById('statewide-content');
      const tempBar = document.getElementById('statewide-temperature-bar');
      if (!statewideContent) return;
      if (totalVotes === 0) {
        statewideContent.innerHTML = '<p>No statewide data available for this contest.</p>';
        if (tempBar) tempBar.style.display = 'none';
        return;
      }
      
      // Calculate other votes
      const otherVotes = Math.max(0, totalVotes - demVotes - repVotes);
      
      const demPct = (demVotes / totalVotes) * 100;
      const repPct = (repVotes / totalVotes) * 100;
      const otherPct = (otherVotes / totalVotes) * 100;
      const marginPct = Math.abs(demPct - repPct);
      const winner = demPct > repPct ? 'Democratic' : 'Republican';
      const loser = demPct > repPct ? 'Republican' : 'Democratic';
      let officeName = formatContestName(contestType, year);
      let demKey = `${year}|${officeName}|Democrat`;
      let repKey = `${year}|${officeName}|Republican`;
      let demCandidate = getCandidateName(year, officeName, 'Democrat');
      let repCandidate = getCandidateName(year, officeName, 'Republican');
      if ((year == 2008 && officeName === 'President of the United States') || (year == 2010 && officeName === 'Governor')) {
        console.log('DEBUG Candidate Lookup:', { demKey, demCandidate, repKey, repCandidate });
      }
      // Show winner, margin, total votes, competitiveness, and split temperature bar styled like Georgia example
      // Calculate competitiveness
      let compLabel = '';
      let compColor = '#6b7280';
      // Use county analysis sidebar color logic for competitiveness
      if (marginPct >= 40) {
        compLabel = winner === 'Republican' ? "Annihilation Republican (40%+)" : "Annihilation Democratic (40%+)";
        compColor = winner === 'Republican' ? '#450a0a' : '#0c1d56';
      } else if (marginPct >= 30 && marginPct <= 39.99) {
        compLabel = winner === 'Republican' ? "Dominant Republican (30.00-39.99%)" : "Dominant Democratic (30.00-39.99%)";
        compColor = winner === 'Republican' ? '#7f1d1d' : '#1e3a8a';
      } else if (marginPct >= 20 && marginPct <= 29.99) {
        compLabel = winner === 'Republican' ? "Stronghold Republican (20.00-29.99%)" : "Stronghold Democratic (20.00-29.99%)";
        compColor = winner === 'Republican' ? '#991b1b' : '#1e40af';
      } else if (marginPct >= 10 && marginPct <= 19.99) {
        compLabel = winner === 'Republican' ? "Safe Republican (10.00-19.99%)" : "Safe Democratic (10.00-19.99%)";
        compColor = winner === 'Republican' ? '#dc2626' : '#3b82f6';
      } else if (marginPct >= 5.50 && marginPct <= 9.99) {
        compLabel = winner === 'Republican' ? "Likely Republican (5.50-9.99%)" : "Likely Democratic (5.51-9.99%)";
        compColor = winner === 'Republican' ? '#ef4444' : '#60a5fa';
      } else if (marginPct >= 1 && marginPct <= 5.49) {
        compLabel = winner === 'Republican' ? "Lean Republican (1.00-5.49%)" : "Lean Democratic (1.00-5.49%)";
        compColor = winner === 'Republican' ? '#f87171' : '#93c5fd';
      } else if (marginPct >= 0.50 && marginPct <= 0.99) {
        compLabel = winner === 'Republican' ? "Tilt Republican (0.50-0.99%)" : "Tilt Democratic (0.50-0.99%)";
        compColor = winner === 'Republican' ? '#fca5a5' : '#bfdbfe';
      } else {
        compLabel = winner === 'Democratic' ? 'Tossup (Democratic Win - <0.50%)' : 'Tossup (Republican Win - <0.50%)';
        compColor = winner === 'Democratic' ? '#2563eb' : '#dc2626'; // Blue for Dem win, Red for Rep win
      }
      
      // Build the horizontal bar with D/R/Other if present
      let barHTML = '';
      let barFlex = '';
      if (otherVotes > 0) {
        // Show D, R, Other in bar
        barFlex = `<div style="width:${demPct}%;background:#2563eb;"></div><div style="width:${repPct}%;background:#dc2626;"></div><div style="width:${otherPct}%;background:#6b7280;"></div>`;
      } else {
        barFlex = `<div style="width:${demPct}%;background:#2563eb;"></div><div style="width:${repPct}%;background:#dc2626;"></div>`;
      }
      barHTML = `<div id="statewide-temperature-bar" style="width:100%;height:32px;border-radius:16px;display:flex;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.08);">${barFlex}</div>`;
      
      // Build the D/R/Other breakdown row
      let breakdownRow = `<div style="display:flex;justify-content:space-between;margin-top:6px;">`;
      breakdownRow += `<div style="color:#2563eb;font-size:15px;font-weight:700;">D: ${demVotes.toLocaleString()} (${demPct.toFixed(2)}%)</div>`;
      breakdownRow += `<div style="color:#dc2626;font-size:15px;font-weight:700;">R: ${repVotes.toLocaleString()} (${repPct.toFixed(2)}%)</div>`;
      if (otherVotes > 0) {
        breakdownRow += `<div style="color:#6b7280;font-size:15px;font-weight:700;">Other: ${otherVotes.toLocaleString()} (${otherPct.toFixed(2)}%)</div>`;
      }
      breakdownRow += `</div>`;
      
      statewideContent.innerHTML = `
        <div class="statewide-margin" style="margin-bottom:0;">
          <div class="margin-text" style="color: ${winner === 'Republican' ? '#dc2626' : '#2563eb'};font-size:18px;font-weight:700;text-align:left;">
            Winner: <span style="color:${winner === 'Republican' ? '#dc2626' : '#2563eb'}">${winner === 'Republican' ? repCandidate : demCandidate} (${winner === 'Republican' ? 'R' : 'D'})</span><br>
            Margin: <span style="color:${winner === 'Republican' ? '#dc2626' : '#2563eb'}">${winner === 'Republican' ? 'R+' : 'D+'}${marginPct.toFixed(2)}%</span> <span style="color:#64748b;font-size:14px;">(${Math.abs(repVotes-demVotes).toLocaleString()} votes)</span>
          </div>
          <div style="margin-top:8px;">
            ${barHTML}
            ${breakdownRow}
          </div>
          <div style="margin-top:10px;font-size:15px;color:#374151;font-weight:600;">
            Total Votes: ${totalVotes.toLocaleString()}
          </div>
          <div style="margin-top:4px;font-size:15px;font-weight:600;color:${compColor};">
            Competitiveness: ${compLabel}
          </div>
        </div>
      `;
    }

    function setMapView(view) {
      currentView = view;
      
      // Update button states
      document.getElementById('counties-view').classList.toggle('active', view === 'counties');
      document.getElementById('districts-view').classList.toggle('active', view === 'districts');
      document.getElementById('state-house-view').classList.toggle('active', view === 'state_house');
      document.getElementById('state-senate-view').classList.toggle('active', view === 'state_senate');
      
      // Update 2000 VTDs button if available
      const vtds2000Button = document.getElementById('vtds-2000-view');
      if (vtds2000Button) {
        vtds2000Button.classList.toggle('active', view === 'vtds_2000');
      }
      
      // Update sidebar title
      const sidebarTitle = document.querySelector('.sidebar-header h3');
      const titles = {
        'counties': 'üìä County Analysis',
        'districts': 'üìä Congressional District Analysis', 
        'state_house': 'üìä State House District Analysis',
        'state_senate': 'üìä State Senate District Analysis',
        'vtds_2000': 'üìä 2000 Precinct Analysis'
      };
      sidebarTitle.textContent = titles[view];
      
      // Clear all map layers
      const layerTypes = ['county', 'district', 'state-house', 'state-senate', 'vtds-2000'];
      layerTypes.forEach(type => {
        if (map.getLayer(`${type}-fill`)) {
          map.removeLayer(`${type}-fill`);
          map.removeLayer(`${type}-stroke`);
        }
      });
      
      // Add appropriate layers
      if (view === 'counties') {
        addCountyLayers();
      } else if (view === 'districts') {
        addDistrictLayers();
      } else if (view === 'state_house') {
        addStateHouseLayers();
      } else if (view === 'state_senate') {
        addStateSenatelayers();
      } else if (view === 'vtds_2000') {
        add2000VTDLayers();
      }
      
      // Repopulate contest selector
      populateContestSelectFromElectionJSON(electionData);
      
      // Clear current selection
      document.getElementById('contestSelect').value = '';
      clearCountyDetails();
    }

    // Placeholder function for 2000 VTD layers (will be implemented when data is available)
    function add2000VTDLayers() {
      if (typeof window.vtds2000Data === 'undefined') {
        setStatus('2000 VTD data not loaded. Please load VTD shapefiles and election data.');
        // Switch back to counties view
        setMapView('counties');
        return;
      }
      
      if (!map.getLayer('vtds-2000-fill')) {
        map.addLayer({ 
          id: 'vtds-2000-fill', 
          type: 'fill', 
          source: 'vtds-2000', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.3 } 
        });
        map.addLayer({ 
          id: 'vtds-2000-stroke', 
          type: 'line', 
          source: 'vtds-2000', 
          paint: { 'line-color': '#666', 'line-width': 0.5 } 
        });
        
        // Add click handler for VTDs
        map.on('click', 'vtds-2000-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const vtdProps = e.features[0].properties;
            const vtdId = vtdProps.VTD || vtdProps.VTDST || vtdProps.NAME || 'Unknown';
            
            // Show VTD details
            showVTDDetails(vtdId, vtdProps);
          }
        });
        
        setStatus('2000 VTD layer loaded');
      }
    }
    
    // Function to show VTD details (placeholder)
    function showVTDDetails(vtdId, vtdProps) {
      const detailsDiv = document.getElementById('area-details');
      detailsDiv.innerHTML = `
        <h4>2000 Precinct ${vtdId}</h4>
        <div class="data-row">
          <span class="label">VTD ID:</span>
          <span class="value">${vtdId}</span>
        </div>
        <div class="data-row">
          <span class="label">Properties:</span>
          <span class="value">${Object.keys(vtdProps).length} attributes</span>
        </div>
        <p><em>Election results will be displayed when precinct-level data is loaded.</em></p>
      `;
      detailsDiv.style.display = 'block';
    }

    function toggleLegend() {
      const legend = document.getElementById('legend');
      const legendContent = document.getElementById('legend-content');
      const minimizeBtn = document.getElementById('legend-minimize-btn');
      
      if (legend.classList.contains('minimized')) {
        // Expand legend
        legend.classList.remove('minimized');
        legendContent.style.display = 'block';
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize legend';
      } else {
        // Minimize legend
        legend.classList.add('minimized');
        legendContent.style.display = 'none';
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand legend';
      }
      updateMobilePanelOffsets();
    }

    // Toggles the visibility of the main controls panel, minimizing or expanding it based on its current state.
    function toggleMainControls() {
      const controls = document.getElementById('main-controls');
      const controlsContent = document.getElementById('controls-content');
      const minimizeBtn = document.getElementById('controls-minimize-btn');
      
      if (controls.classList.contains('minimized')) {
        // Expand controls
        controls.classList.remove('minimized');
        controlsContent.style.display = 'block';
        minimizeBtn.textContent = '‚àí';
        minimizeBtn.title = 'Minimize controls';
      } else {
        // Minimize controls
        controls.classList.add('minimized');
        controlsContent.style.display = 'none';
        minimizeBtn.textContent = '+';
        minimizeBtn.title = 'Expand controls';
      }
      updateMobilePanelOffsets();
    }

    function updateMobilePanelOffsets() {
      if (window.innerWidth > 768) return;
      const controls = document.getElementById('main-controls');
      if (!controls) return;
      const controlsHeight = controls.classList.contains('minimized')
        ? 64
        : Math.ceil(controls.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--mobile-controls-offset', `${controlsHeight + 12}px`);
    }

    window.addEventListener('resize', updateMobilePanelOffsets);
    window.addEventListener('orientationchange', updateMobilePanelOffsets);
    document.addEventListener('DOMContentLoaded', function() {
      updateMobilePanelOffsets();
      setTimeout(updateMobilePanelOffsets, 120);
    });

    function showCountyDetails(countyName) {
      // --- NC Map Card-Style Sidebar ---
      const sidebar = document.getElementById('sidebar');
      let sidebarContent = '';
      const detailsDiv = document.getElementById('county-details');
      const contentEl = document.getElementById('county-info-content');
      // sidebarContent will be declared once below
      if (!contentEl || !detailsDiv) return;
      if (sidebar) {
        sidebar.classList.remove('minimized');
        const sidebarContentEl = document.querySelector('.sidebar-content');
        if (sidebarContentEl) sidebarContentEl.style.display = 'block';
        const floatBtn = document.getElementById('sidebar-float-toggle');
        if (floatBtn) {
          floatBtn.textContent = '‚àí';
          floatBtn.title = 'Minimize sidebar';
        }
        const btn = document.getElementById('sidebar-minimize-btn');
        if (btn) {
          btn.textContent = '‚àí';
          btn.title = 'Minimize sidebar';
        }
      }
      const countyNameElement = document.getElementById('county-name');
      if (countyNameElement) countyNameElement.textContent = countyName + ' County';
      // sidebarContent already declared above
      // Guard: election results must exist
      if (!currentElectionResults) {
        contentEl.innerHTML = '<p>Select a contest to see county results.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      // Normalize and find county data
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      let norm = normalizeCountyName(countyName);
      let countyData = currentElectionResults[norm];
      if (!countyData) {
        for (const key in currentElectionResults) {
          if (normalizeCountyName(key) === norm) {
            countyData = currentElectionResults[key];
            break;
          }
        }
      }
      if (!countyData) {
        contentEl.innerHTML = '<p>No results found for this county in the selected contest.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      // Get contest info
      const contestSelect = document.getElementById('contestSelect');
      const contestKey = contestSelect && contestSelect.value;
      if (!contestKey) {
        contentEl.innerHTML = '<p>Select a contest to see detailed results.</p>';
        detailsDiv.style.display = 'block';
        return;
      }
      const lastUnderscoreIndex = contestKey.lastIndexOf('_');
      const contestType = contestKey.substring(0, lastUnderscoreIndex);
      const year = contestKey.substring(lastUnderscoreIndex + 1);
      // Votes
      const demVotes = countyData[`${contestType}_dem`] || 0;
      const repVotes = countyData[`${contestType}_rep`] || 0;
      const totalVotes = countyData[`${contestType}_total`] || 0;
      if (totalVotes === 0) {
        contentEl.innerHTML = `<p>No ${formatContestName(contestType, year)} data available for ${countyName} County in ${year}.</p>`;
        detailsDiv.style.display = 'block';
        return;
      }
      const demPct = (demVotes / totalVotes * 100);
      const repPct = (repVotes / totalVotes * 100);
      // Candidate names
  let demCandidate = getCandidateName(year, formatContestName(contestType, year), 'Democrat');
  let repCandidate = getCandidateName(year, formatContestName(contestType, year), 'Republican');
      // Margin
      const margin = demVotes - repVotes;
      const marginPct = (Math.abs(margin) / totalVotes * 100).toFixed(2);
      const winner = margin > 0 ? 'Democratic' : (margin < 0 ? 'Republican' : 'Tie');
      const winnerCandidate = margin > 0 ? demCandidate : repCandidate;
      const marginText = margin > 0 ? 'D+' + marginPct + '%' : (margin < 0 ? 'R+' + marginPct + '%' : 'Tied');
      // Accessibility palette for winner color
      function cbColorForMargin(marginPct, winner) {
        if (marginPct >= 40) {
          return winner === 'Republican' ? '#cc5500' : '#004d99';
        } else if (marginPct >= 30 && marginPct <= 39.99) {
          return winner === 'Republican' ? '#ff6600' : '#0066cc';
        } else if (marginPct >= 20 && marginPct <= 29.99) {
          return winner === 'Republican' ? '#ff8833' : '#0080ff';
        } else if (marginPct >= 10 && marginPct <= 19.99) {
          return winner === 'Republican' ? '#ffaa55' : '#3399ff';
        } else if (marginPct >= 5.51 && marginPct <= 9.99) {
          return winner === 'Republican' ? '#ffcc77' : '#66b3ff';
        } else if (marginPct >= 1 && marginPct <= 5.5) {
          return winner === 'Republican' ? '#ffdd99' : '#99ccff';
        } else if (marginPct >= 0.51 && marginPct <= 0.99) {
          return winner === 'Republican' ? '#ffeecc' : '#b3d9ff';
        } else {
          return '#cccccc';
        }
      }
      const isColorblind = document.body.classList.contains('colorblind-mode');
      // Accessibility palette for winner color (always orange/yellow for Republican in colorblind mode)
      let winnerColor = '#dc2626';
      if (winner === 'Republican') {
        if (isColorblind) {
          if (parseFloat(marginPct) >= 40) winnerColor = '#cc5500';
          else if (parseFloat(marginPct) >= 30) winnerColor = '#ff6600';
          else if (parseFloat(marginPct) >= 20) winnerColor = '#ff8833';
          else if (parseFloat(marginPct) >= 10) winnerColor = '#ffaa55';
          else if (parseFloat(marginPct) >= 5.5) winnerColor = '#ffcc77';
          else if (parseFloat(marginPct) >= 1) winnerColor = '#ffdd99';
          else if (parseFloat(marginPct) >= 0.5) winnerColor = '#ffeecc';
          else winnerColor = '#cccccc';
        }
      } else {
        winnerColor = isColorblind ? cbColorForMargin(parseFloat(marginPct), 'D') : '#2563eb';
      }
      // Precincts (if available)
      let precincts = '';
      if (countyData.precincts || countyData.Precincts || countyData.PRECINCTS) {
        precincts = countyData.precincts || countyData.Precincts || countyData.PRECINCTS;
      }
      // Card-style layout
      sidebarContent += '<div class="result-summary">';
      sidebarContent += '<h3 class="sidebar-section-title">üìä Election Results</h3>';
      if (precincts) sidebarContent += `<div style="font-size:14px;"><b>Precincts:</b> ${precincts}</div>`;
      sidebarContent += `<div style="font-size:14px;margin-bottom:10px;"><b>Total Votes:</b> ${totalVotes.toLocaleString()}</div>`;
      sidebarContent += `</div>`;
    sidebarContent += `<div class="winner-section">`;
  sidebarContent += '<h3 class="sidebar-section-title">üèÜ Winner</h3>';
  sidebarContent += `<p class="sidebar-winner" style="color: ${winnerColor}; font-weight: bold;">${winnerCandidate} (${winner === 'Republican' ? 'R' : 'D'})</p>`;
  sidebarContent += `</div>`;
  sidebarContent += `<div class="margin-section">`;
  sidebarContent += '<h3 class="sidebar-section-title">üìà Margin</h3>';
  let marginColor = winnerColor;
  if (winner !== 'Republican') {
    marginColor = isColorblind ? cbColorForMargin(parseFloat(marginPct), 'D') : '#2563eb';
  }
  sidebarContent += `<p class="sidebar-margin" style="color: ${marginColor}; font-weight: bold;">${winner === 'Republican' ? 'R+' : 'D+'}${marginPct}%</p>`;
  sidebarContent += `<p class="sidebar-margin-details" style="color: #6b7280;">(${Math.abs(margin).toLocaleString()} vote margin)</p>`;
  sidebarContent += `</div>`;
  sidebarContent += `<div class="vote-breakdown">`;
  sidebarContent += '<h3 class="sidebar-section-title">üó≥Ô∏è Vote Breakdown</h3>';
  // For colorblind mode, use the correct accessibility palette for Republican vote breakdown
  let repColor = '#ef3b2c';
  if (isColorblind) {
    if (parseFloat(marginPct) >= 40) repColor = '#cc5500';
    else if (parseFloat(marginPct) >= 30 && parseFloat(marginPct) <= 39.99) repColor = '#ff6600';
    else if (parseFloat(marginPct) >= 20 && parseFloat(marginPct) <= 29.99) repColor = '#ff8833';
    else if (parseFloat(marginPct) >= 10 && parseFloat(marginPct) <= 19.99) repColor = '#ffaa55';
    else if (parseFloat(marginPct) >= 5.51 && parseFloat(marginPct) <= 9.99) repColor = '#ffcc77';
    else if (parseFloat(marginPct) >= 1 && parseFloat(marginPct) <= 5.5) repColor = '#ffdd99';
    else if (parseFloat(marginPct) >= 0.51 && parseFloat(marginPct) <= 0.99) repColor = '#ffeecc';
    else repColor = '#cccccc';
  } else {
    // Non-accessibility mode: always use red for Republican vote breakdown
    repColor = '#ef3b2c';
  }
  let demColor;
  if (isColorblind) {
    demColor = cbColorForMargin(parseFloat(marginPct), 'D');
  } else {
    // Non-accessibility mode: always use regular blue for Democratic vote breakdown
    demColor = '#2563eb';
  }
  sidebarContent += `<p class="sidebar-breakdown"><span style="color: ${demColor}; font-weight: bold;">${demCandidate} (D)</span> : ${demPct.toFixed(2)}% (${demVotes.toLocaleString()})</p>`;
  sidebarContent += `<p class="sidebar-breakdown"><span style="color: ${repColor}; font-weight: bold;">${repCandidate} (R)</span> : ${repPct.toFixed(2)}% (${repVotes.toLocaleString()})</p>`;
  
  // Add Other votes if they exist
  const otherVotes = countyData[`${contestType}_other`] || 0;
  if (otherVotes > 0) {
    const otherPct = (otherVotes / totalVotes * 100);
    sidebarContent += `<p class="sidebar-breakdown"><span style="color: #6b7280; font-weight: bold;">Other Candidates</span> : ${otherPct.toFixed(2)}% (${otherVotes.toLocaleString()})</p>`;
  }
  
  sidebarContent += `</div>`;
  // Competitiveness
  let competitiveness;
  const actualMarginPct = parseFloat(marginPct);
  if (actualMarginPct >= 40) {
    competitiveness = winner === 'Republican' ? "Annihilation Republican" : "Annihilation Democratic";
  } else if (actualMarginPct >= 30 && actualMarginPct <= 39.99) {
    competitiveness = winner === 'Republican' ? "Dominant Republican" : "Dominant Democratic";
  } else if (actualMarginPct >= 20 && actualMarginPct <= 29.99) {
    competitiveness = winner === 'Republican' ? "Stronghold Republican" : "Stronghold Democratic";
  } else if (actualMarginPct >= 10 && actualMarginPct <= 19.99) {
    competitiveness = winner === 'Republican' ? "Safe Republican" : "Safe Democratic";
  } else if (actualMarginPct >= 5.51 && actualMarginPct <= 9.99) {
    competitiveness = winner === 'Republican' ? "Likely Republican" : "Likely Democratic";
  } else if (actualMarginPct >= 1 && actualMarginPct <= 5.5) {
    competitiveness = winner === 'Republican' ? "Lean Republican" : "Lean Democratic";
  } else if (actualMarginPct >= 0.51 && actualMarginPct <= 0.99) {
    competitiveness = winner === 'Republican' ? "Tilt Republican" : "Tilt Democratic";
  } else {
    competitiveness = winner === 'Democratic' ? 'Tossup (Democratic Win)' : 'Tossup (Republican Win)';
  }
  let compColor = '#6b7280';
  // Handle tossup cases with better colors and formatting like index (1).html
  if (competitiveness.includes('Tossup')) {
    compColor = winner === 'Democratic' ? '#2563eb' : '#dc2626'; // Blue for Dem win, Red for Rep win
  } else if (competitiveness.includes('Rep')) {
    if (competitiveness.includes('Annihilation')) compColor = '#450a0a';
    else if (competitiveness.includes('Dominant')) compColor = '#7f1d1d';
    else if (competitiveness.includes('Stronghold')) compColor = '#991b1b';
    else if (competitiveness.includes('Safe')) compColor = '#dc2626';
    else if (competitiveness.includes('Likely')) compColor = '#ef4444';
    else if (competitiveness.includes('Lean')) compColor = '#f87171';
    else if (competitiveness.includes('Tilt')) compColor = '#fca5a5';
  } else if (competitiveness.includes('Dem')) {
    if (competitiveness.includes('Annihilation')) compColor = '#0c1d56';
    else if (competitiveness.includes('Dominant')) compColor = '#1e3a8a';
    else if (competitiveness.includes('Stronghold')) compColor = '#1e40af';
    else if (competitiveness.includes('Safe')) compColor = '#3b82f6';
    else if (competitiveness.includes('Likely')) compColor = '#60a5fa';
    else if (competitiveness.includes('Lean')) compColor = '#93c5fd';
    else if (competitiveness.includes('Tilt')) compColor = '#bfdbfe';
  }
  sidebarContent += `<div class="competitiveness-section">`;
  sidebarContent += '<h5>üéØ Competitiveness</h5>';
  sidebarContent += `<p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>`;
  if (actualMarginPct <= 0.5) {
    sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Extremely close!)</p>`;
  } else if (actualMarginPct <= 0.99) {
    sidebarContent += `<p style="color: #f59e0b; font-style: italic;">(Very close!)</p>`;
  }
  sidebarContent += `</div>`;
  sidebarContent += `</div>`;
  contentEl.innerHTML = sidebarContent;
  detailsDiv.style.display = 'block';
  detailsDiv.style.display = 'block';
}

    function addCountyLayers() {
      if (!map.getLayer('county-fill')) {
        map.addLayer({ 
          id: 'county-fill', 
          type: 'fill', 
          source: 'counties', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.85 } 
        });
        map.addLayer({ 
          id: 'county-stroke', 
          type: 'line', 
          source: 'counties', 
          paint: { 'line-color': '#333', 'line-width': 1 } 
        });
        // County label layer (restore font and background)
        map.addLayer({
          id: 'county-label',
          type: 'symbol',
          source: 'counties',
          layout: {
            'text-field': ['coalesce', ['get', 'NAME20'], ['get', 'County'], ['get', 'COUNTYNAME'], ['get', 'NAME'], ['get', 'name']],
            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
            'text-size': 13,
            'text-anchor': 'center',
            'text-offset': [0, 0],
            'visibility': 'visible'
          },
          paint: {
            'text-color': '#222',
            'text-halo-color': '#f7f7f7', // original background halo
            'text-halo-width': 2
          }
        });
        // Add mouseleave event handler
        map.on('mouseleave', 'county-fill', () => {
          map.getCanvas().style.cursor = '';
        });
        // Add county click event handler
        map.on('click', 'county-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const countyName = e.features[0].properties.NAME20 || e.features[0].properties.County || e.features[0].properties.COUNTYNAME || e.features[0].properties.NAME || e.features[0].properties.name;
            if (countyName) {
              showCountyDetails(countyName);
              lastSelectedCounty = countyName;
              // Optionally, expand sidebar if minimized
              const sidebar = document.getElementById('sidebar');
              if (sidebar && sidebar.classList.contains('minimized')) {
                sidebar.classList.remove('minimized');
                const btn = document.getElementById('sidebar-minimize-btn');
                if (btn) btn.textContent = '‚àí';
              }
            }
          }
        });
        // Quick hover tooltip with basic info
        map.on('mouseenter', 'county-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', 'county-fill', () => {
          map.getCanvas().style.cursor = '';
        });
      }
    }

    function addDistrictLayers() {
      if (!map.getLayer('district-fill')) {
        map.addLayer({ 
          id: 'district-fill', 
          type: 'fill', 
          source: 'districts', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.7 } 
        });
        map.addLayer({ 
          id: 'district-stroke', 
          type: 'line', 
          source: 'districts', 
          paint: { 'line-color': '#1f2937', 'line-width': 2 } 
        });
        
        // Add click handler for districts with full trends popup
        map.on('click', 'district-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const districtNum = e.features[0].properties.DISTRICT;
            if (districtNum) {
              // Show full historical trends popup on click
              const trends = getHistoricalTrends(null, true, districtNum);
              const content = formatTooltipContent(`Congressional District ${districtNum} - Historical Trends`, trends);
              showHoverTooltip(e.point.x, e.point.y, content);
              
              // Also show detailed sidebar
              showDistrictDetails(districtNum);
              lastSelectedCounty = `District ${districtNum}`;
            }
          }
        });
        
        // Quick hover tooltip with basic info
        map.on('mouseenter', 'district-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'district-fill', () => {
          map.getCanvas().style.cursor = '';
        });
      }
    }

    function addStateHouseLayers() {
      if (!map.getLayer('state-house-fill')) {
        map.addLayer({ 
          id: 'state-house-fill', 
          type: 'fill', 
          source: 'state-house', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.6 } 
        });
        map.addLayer({ 
          id: 'state-house-stroke', 
          type: 'line', 
          source: 'state-house', 
          paint: { 'line-color': '#374151', 'line-width': 1 } 
        });
        
        // Add click handler for state house districts with full trends popup
        map.on('click', 'state-house-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const districtNum = e.features[0].properties.DISTRICT;
            if (districtNum) {
              // Show full historical trends popup on click
              const trends = getStateDistrictTrends(districtNum, 'house');
              const content = formatTooltipContent(`State House District ${districtNum} - Historical Trends`, trends);
              showHoverTooltip(e.point.x, e.point.y, content);
              
              // Also show detailed sidebar
              showStateDistrictDetails(districtNum, 'house');
              lastSelectedCounty = `State House District ${districtNum}`;
            }
          }
        });
        
        // Quick hover tooltip with basic info
        map.on('mouseenter', 'state-house-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'state-house-fill', () => {
          map.getCanvas().style.cursor = '';
        });
      }
    }

    function addStateSenatelayers() {
      if (!map.getLayer('state-senate-fill')) {
        map.addLayer({ 
          id: 'state-senate-fill', 
          type: 'fill', 
          source: 'state-senate', 
          paint: { 'fill-color': '#e0e0e0', 'fill-opacity': 0.65 } 
        });
        map.addLayer({ 
          id: 'state-senate-stroke', 
          type: 'line', 
          source: 'state-senate', 
          paint: { 'line-color': '#4b5563', 'line-width': 1 } 
        });
        
        // Add click handler for state senate districts with full trends popup
        map.on('click', 'state-senate-fill', (e) => {
          if (e.features && e.features[0] && e.features[0].properties) {
            const districtNum = e.features[0].properties.DISTRICT;
            if (districtNum) {
              // Show full historical trends popup on click
              const trends = getStateDistrictTrends(districtNum, 'senate');
              const content = formatTooltipContent(`State Senate District ${districtNum} - Historical Trends`, trends);
              showHoverTooltip(e.point.x, e.point.y, content);
              
              // Also show detailed sidebar
              showStateDistrictDetails(districtNum, 'senate');
              lastSelectedCounty = `State Senate District ${districtNum}`;
            }
          }
        });
        
        // Quick hover tooltip with basic info
        map.on('mouseenter', 'state-senate-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
        });
        
        map.on('mouseleave', 'state-senate-fill', () => {
          map.getCanvas().style.cursor = '';
        });
      }
    }

    function clearCountyDetails() {
      document.getElementById('county-details').style.display = 'none';
    }


    // Sidebar minimized by default on load, expand on click
    // County search functionality - Efficient search with limited suggestions
    function setupCountySearch() {
      const countiesSource = map.getSource('counties');
      if (!countiesSource) return;
      
      let counties = [];
      if (countiesSource._data && countiesSource._data.features) {
        // Use NAME20 field (just county name, no "County" suffix)
        counties = countiesSource._data.features.map(f => {
          const p = f.properties || {};
          return p.NAME20 || p.County || p.COUNTYNAME || p.NAME || '';
        }).filter(Boolean).sort();
      }
      
      const searchInput = document.getElementById('county-search');
      if (searchInput && counties.length > 0) {
        // Create dropdown for suggestions (hidden by default)
        let dropdown = document.getElementById('county-dropdown');
        if (!dropdown) {
          dropdown = document.createElement('div');
          dropdown.id = 'county-dropdown';
          dropdown.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          `;
          
          // Make search container relative positioned
          searchInput.parentNode.style.position = 'relative';
          searchInput.parentNode.appendChild(dropdown);
        }
        
        // Only show suggestions when user types
        searchInput.addEventListener('input', function() {
          const searchValue = this.value.trim().toLowerCase();
          if (searchValue.length < 1) {
            dropdown.style.display = 'none';
            return;
          }
          // Match county names
          const matches = counties.filter(county => county.toLowerCase().includes(searchValue)).slice(0, 10);
          if (matches.length > 0) {
            dropdown.innerHTML = matches.map(county => `
              <div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" 
                   onmouseover="this.style.backgroundColor='#f3f4f6'" 
                   onmouseout="this.style.backgroundColor='white'"
                   onclick="selectCounty('${county}')">${county}</div>
            `).join('');
            dropdown.style.display = 'block';
          } else {
            dropdown.style.display = 'none';
          }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
          }
        });
        
        // Handle Enter key
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const val = this.value.trim();
            if (val) {
              dropdown.style.display = 'none';
              handleCountySelection(val);
            }
          }
        });
      }
    }

    // Global function to select county from dropdown
    function selectCounty(countyName) {
      const searchInput = document.getElementById('county-search');
      const dropdown = document.getElementById('county-dropdown');
      
      if (searchInput) {
        searchInput.value = countyName;
        if (dropdown) dropdown.style.display = 'none';
        handleCountySelection(countyName);
      }
    }

    function handleCountySelection(countyName) {
      const searchInput = document.getElementById('county-search');
      // Add visual feedback
      if (searchInput) {
        searchInput.style.borderColor = '#10b981';
        setTimeout(() => {
          searchInput.style.borderColor = '#d1d5db';
        }, 1000);
      }
      // Find and zoom to the county using countiesData and Turf.js
      // Prefer the authoritative source: window.countiesData if present, otherwise try map source
      const src = (window.countiesData && window.countiesData.features) ? window.countiesData : (map.getSource && map.getSource('counties') && (map.getSource('counties')._data || map.getSource('counties').data)) || null;
      if (countyName && src && src.features) {
        // Normalize input for matching
        function normalize(name) {
          return (name || '').toString().replace(/[^a-z0-9 ]/gi, '').replace(/\s+/g, ' ').trim().toUpperCase();
        }
        const normTarget = normalize(countyName);
        let found = false;
        // First try exact match
        src.features.forEach(f => {
          const props = f.properties || {};
          const rawName = props.NAME20 || props.NAMELSAD20 || props.county_name || props.County || props.COUNTYNAME || props.NAME || props.name || '';
          const n = normalize(rawName);
          if (n === normTarget) {
            found = f;
          }
        });
        // If no exact match, try containment (user types 'Jackson' vs 'Jackson County')
        if (!found) {
          src.features.forEach(f => {
            const props = f.properties || {};
            const rawName = props.NAME20 || props.NAMELSAD20 || props.county_name || props.County || props.COUNTYNAME || props.NAME || props.name || '';
            const n = normalize(rawName);
            if (n.indexOf(normTarget) !== -1 || normTarget.indexOf(n) !== -1) {
              if (!found) found = f; // pick first sensible hit
            }
          });
        }

        if (found) {
          const props = found.properties || {};
          lastSelectedCounty = props.NAME20 || props.NAMELSAD20 || props.county_name || props.County || props.COUNTYNAME || props.NAME || props.name;
          const bbox = turf.bbox(found);
          console.log('[DIAGNOSTIC] Matched county for', countyName, '->', lastSelectedCounty, 'bbox:', bbox);
          map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], { padding: 40, duration: 1000 });
          showCountyDetails(lastSelectedCounty);
          const sidebar = document.getElementById('sidebar');
          if (sidebar && sidebar.classList.contains('minimized')) {
            toggleSidebar();
          }
        } else {
          console.warn('[DIAGNOSTIC] County not found:', countyName, 'normalized:', normTarget);
        }
      }
    }

    function getHistoricalTrends(countyName, isDistrict = false, districtNum = null) {
      const presidentialYears = [2024, 2020, 2016, 2012, 2008];
      const stateHouseYears = [2024, 2022, 2020, 2018, 2016]; // Recent state house elections
      const governorYears = [2022, 2018, 2014, 2010]; // Add this line for governor years
      const trends = [];
      
      if (isDistrict && districtNum) {
        // For congressional districts, use congressional data
        presidentialYears.forEach(year => {
          const data = congressionalData.find(row => 
            row.year == year && row.district == districtNum
          );
          
          if (data && data.us_house_total > 0) {
            const demVotes = data.us_house_dem || 0;
            const repVotes = data.us_house_rep || 0;
            const totalVotes = data.us_house_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              trends.push({
                year: year,
                display: `${year}: ${winner}+${marginAbs.toFixed(1)}`,
                margin: margin,
                type: 'house'
              });
            }
          }
        });

      } else {
        // For counties, show both presidential and recent state house trends
        
        // Presidential trends
        presidentialYears.forEach(year => {
          const data = electionData.find(row => 
            row.year == year && row.county === countyName
          );
          
          if (data && data.president_total > 0) {
            const demVotes = data.president_dem || 0;
            const repVotes = data.president_rep || 0;
            const totalVotes = data.president_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              // Get candidate names for recent years
              let candidateInfo = '';
              if (year === 2024) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2020) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2016) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2012) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              else if (year === 2008) candidateInfo = margin > 0 ? getCandidateName(year, 'President of the United States', 'Democrat') : getCandidateName(year, 'President of the United States', 'Republican');
              
              trends.push({
                year: year,
                display: `${year}: ${candidateInfo}+${marginAbs.toFixed(1)}`,
                margin: margin,
                type: 'president'
              });
            }
          }
        });
        
        // Add separator if we have presidential data
        if (trends.length > 0) {
          trends.push({
            year: 0,
            display: '--- State House ---',
            margin: 0,
            type: 'separator'
          });
        }
        
        // State House trends (recent years only)
        // Governor trends (recent years only)
        governorYears.forEach(year => {
          const data = electionData.find(row => 
            row.year == year && row.county === countyName
          );
          if (data && data.governor_total > 0) {
            const demVotes = data.governor_dem || 0;
            const repVotes = data.governor_rep || 0;
            const totalVotes = data.governor_total || 0;
            const demPct = (demVotes / totalVotes) * 100;
            const repPct = (repVotes / totalVotes) * 100;
            const margin = demPct - repPct;
            const winner = margin > 0 ? 'D' : 'R';
            const marginAbs = Math.abs(margin);
            let candidateInfo = '';
            candidateInfo = margin > 0 ? getCandidateName(year, 'Governor', 'Democrat') : getCandidateName(year, 'Governor', 'Republican');
            trends.push({
              year: year,
              display: `${year}: ${candidateInfo}+${marginAbs.toFixed(1)}`,
              margin: margin,
              type: 'governor'
            });
          }
        });
        stateHouseYears.forEach(year => {
          const data = electionData.find(row => 
            row.year == year && row.county === countyName
          );
          
          if (data && data.state_house_total > 0) {
            const demVotes = data.state_house_dem || 0;
            const repVotes = data.state_house_rep || 0;
            const totalVotes = data.state_house_total || 0;
            
            if (totalVotes > 0) {
              const demPct = (demVotes / totalVotes) * 100;
              const repPct = (repVotes / totalVotes) * 100;
              const margin = demPct - repPct;
              const winner = margin > 0 ? 'D' : 'R';
              const marginAbs = Math.abs(margin);
              
              trends.push({
                year: year,
                display: `${year}: ${winner}+${marginAbs.toFixed(1)} (House)`,
                margin: margin,
                type: 'state_house'
              });
            }
          }
        });
      }
      
      return trends;
    }

    function formatTooltipContent(title, trends) {
      let trendsHtml = '';
      if (trends.length > 0) {
        trendsHtml = trends.map(t => {
          if (t.type === 'separator') {
            return `<div style="color: #999; font-style: italic; margin: 6px 0; border-top: 1px solid #444; padding-top: 6px;">${t.display}</div>`;
          }
          
          const color = t.margin > 0 ? '#3b82f6' : '#ef4444'; // Blue for Dem, Red for Rep
          return `<div style="color: ${color};">${t.display}</div>`;
        }).join('');
      } else {
        trendsHtml = '<div style="color: #999;">No historical data</div>';
      }
      
      return `
        <div class="tooltip-title">${title}</div>
        <div class="tooltip-trends">${trendsHtml}</div>
      `;
    }

    function showDistrictDetails(districtNum) {
      const detailsDiv = document.getElementById('county-details');
      const nameEl = document.getElementById('county-name');
      const contentEl = document.getElementById('county-info-content');
      
      nameEl.textContent = `Congressional District ${districtNum}`;
      
      // Get district info from districtsInfo CSV
      const districtInfo = districtsInfo.find(d => d.district == districtNum);
      
      let demographicInfo = '';
      if (districtInfo) {
        demographicInfo = `
          <div style="margin-bottom: 16px;">
            <h5>üë• Demographics (VAP)</h5>
            <p><strong>Total Population:</strong> ${districtInfo.total_population.toLocaleString()}</p>
            <p><strong>White:</strong> ${districtInfo.white_vap_pct}%</p>
            <p><strong>Black:</strong> ${districtInfo.black_vap_pct}%</p>
            <p><strong>Hispanic:</strong> ${districtInfo.hispanic_vap_pct}%</p>
          </div>
        `;
      }
      
      // Get current contest results if available
      const contestValue = document.getElementById('contestSelect').value;
      let electionInfo = '';
      
      if (contestValue && congressionalData) {
        const [contestType, year] = contestValue.split('_');
        if (contestType === 'us_house') {
          const result = congressionalData.find(row => 
            row.year == year && row.district == districtNum
          );
          
          if (result && result.us_house_total > 0) {
            const demVotes = result.us_house_dem || 0;
            const repVotes = result.us_house_rep || 0;
            const totalVotes = result.us_house_total || 0;
            
            const demPct = totalVotes > 0 ? (demVotes / totalVotes) * 100 : 0;
            const repPct = totalVotes > 0 ? (repVotes / totalVotes) * 100 : 0;
            const marginPct = Math.abs(demPct - repPct);
            const winner = demPct > repPct ? 'Democratic' : 'Republican';
            
            // Determine competitiveness
            let competitiveness;
            if (marginPct >= 40) {
              competitiveness = winner === 'Republican' ? 'Annihilation Republican' : 'Annihilation Democratic';
            } else if (marginPct >= 30 && marginPct <= 39.99) {
              competitiveness = winner === 'Republican' ? 'Dominant Republican' : 'Dominant Democratic';
            } else if (marginPct >= 20 && marginPct <= 29.99) {
              competitiveness = winner === 'Republican' ? 'Stronghold Republican' : 'Stronghold Democratic';
            } else if (marginPct >= 10 && marginPct <= 19.99) {
              competitiveness = winner === 'Republican' ? 'Safe Republican' : 'Safe Democratic';
            } else if (marginPct >= 5.51 && marginPct <= 9.99) {
              competitiveness = winner === 'Republican' ? 'Likely Republican' : 'Likely Democratic';
            } else if (marginPct >= 1 && marginPct <= 5.5) {
              competitiveness = winner === 'Republican' ? 'Lean Republican' : 'Lean Democratic';
            } else if (marginPct >= 0.51 && marginPct <= 0.99) {
              competitiveness = winner === 'Republican' ? 'Tilt Republican' : 'Tilt Democratic';
            } else {
              competitiveness = winner === 'Democratic' ? 'Tossup (Democratic Win)' : 'Tossup (Republican Win)';
            }
            let compColor = '#6b7280';
            // Handle tossup cases with better colors and formatting like index (1).html
            if (competitiveness.includes('Tossup')) {
              compColor = winner === 'Democratic' ? '#2563eb' : '#dc2626'; // Blue for Dem win, Red for Rep win
            } else if (competitiveness.includes('Rep')) {
              if (competitiveness.includes('Annihilation')) compColor = '#67000d';
              else if (competitiveness.includes('Dominant')) compColor = '#a50f15';
              else if (competitiveness.includes('Stronghold')) compColor = '#cb181d';
              else if (competitiveness.includes('Safe')) compColor = '#ef3b2c';
              else if (competitiveness.includes('Likely')) compColor = '#fb6a4a';
              else if (competitiveness.includes('Lean')) compColor = '#fcae91';
              else if (competitiveness.includes('Tilt')) compColor = '#fee8c8';
            } else if (competitiveness.includes('Dem')) {
              if (competitiveness.includes('Annihilation')) compColor = '#08306b';
              else if (competitiveness.includes('Dominant')) compColor = '#08519c';
              else if (competitiveness.includes('Stronghold')) compColor = '#3182bd';
              else if (competitiveness.includes('Safe')) compColor = '#6baed6';
              else if (competitiveness.includes('Likely')) compColor = '#9ecae1';
              else if (competitiveness.includes('Lean')) compColor = '#c6dbef';
              else if (competitiveness.includes('Tilt')) compColor = '#e1f5fe';
            }
            
            electionInfo = `
              <div style="margin-bottom: 16px;">
                <h5>üéØ Competitiveness</h5>
                <p style="color: ${compColor}; font-weight: bold; font-size: 16px;">${competitiveness}</p>
              </div>
              <div style="margin-bottom: 16px;">
                <h5>üìà Margin</h5>
                <p style="color: ${winner === 'Republican' ? '#dc2626' : '#1e40af'}; font-weight: bold; font-size: 18px;">
                  ${winner} +${marginPct.toFixed(1)}%
                </p>
              </div>
              <div style="margin-bottom: 16px;">
                <h5>üó≥Ô∏è Vote Breakdown</h5>
                <p><span style="color: #1e40af; font-weight: bold;">Democratic: </span>${demPct.toFixed(1)}% (${demVotes.toLocaleString()})</p>
                <p><span style="color: #dc2626; font-weight: bold;">Republican: </span>${repPct.toFixed(1)}% (${repVotes.toLocaleString()})</p>
                <p><strong>Total Votes:</strong> ${totalVotes.toLocaleString()}</p>
              </div>
            `;
          }
        }
      }
      
      contentEl.innerHTML = demographicInfo + electionInfo;
      detailsDiv.style.display = 'block';
    }

    function showStateDistrictDetails(districtNum, chamber) {
      const detailsDiv = document.getElementById('county-details');
      const nameEl = document.getElementById('county-name');
      const contentEl = document.getElementById('county-info-content');
      
      const title = chamber === 'house' ? `State House District ${districtNum}` : `State Senate District ${districtNum}`;
      nameEl.textContent = title;
      
      // Get district info from appropriate CSV
      const districtInfo = chamber === 'house' 
        ? stateHouseInfo?.find(d => d.district == districtNum)
        : stateSenateInfo?.find(d => d.district == districtNum);
      
      let demographicInfo = '';
      if (districtInfo) {
        demographicInfo = `
          <div style="margin-bottom: 16px;">
            <h5>üë• Demographics (VAP)</h5>
            <p><strong>Total Population:</strong> ${districtInfo.total_population.toLocaleString()}</p>
            <p><strong>White:</strong> ${districtInfo.white_vap_pct}%</p>
            <p><strong>Black:</strong> ${districtInfo.black_vap_pct}%</p>
            <p><strong>Hispanic:</strong> ${districtInfo.hispanic_vap_pct}%</p>
          </div>
        `;
      }
      
      // Get current contest results if available
      const contestValue = document.getElementById('contestSelect').value;
      let electionInfo = '';
      
      if (contestValue && electionData) {
        const [contestType, year] = contestValue.split('_');
        if (contestType === expectedType) {
          // For state legislative districts, we need to aggregate county data by district
          // This is complex without a county-to-district mapping, so show general message
          electionInfo = `
            <div style="margin-bottom: 16px;">
              <h5>üìä ${year} ${chamber === 'house' ? 'State House' : 'State Senate'}</h5>
              <p style="color: #666; font-style: italic;">District-level results require county-to-district mapping. 
              Click to see general trends for this contest type.</p>
            </div>
          `;
        }
      }
      
      contentEl.innerHTML = demographicInfo + electionInfo;
      detailsDiv.style.display = 'block';
    }

    function getStateDistrictTrends(districtNum, chamber) {
      // For state legislative districts, we'll show recent election years
      const recentYears = [2024, 2022, 2020, 2018, 2016];
      const trends = [];
      
      // This is simplified - in reality you'd need county-to-district mapping
      // For now, just show that data is available
      recentYears.forEach(year => {
        const contestType = chamber === 'house' ? 'state_house' : 'state_senate';
        const hasData = electionData.some(row => 
          row.year == year && row[`${contestType}_total`] > 0
        );
        
        if (hasData) {
          trends.push({
            year: year,
            display: `${year}: Data Available`,
            margin: 0,
            type: contestType
          });
        }
      });
      
      if (trends.length === 0) {
        trends.push({
          year: 0,
          display: 'District mapping needed',
          margin: 0,
          type: 'info'
        });
      }
      
      return trends;
    }

    // Quick info functions for hover tooltips
    function getQuickCountyInfo(countyName) {
      // Find the most recent presidential election data
      const recent = electionData
        .filter(row => row.county === countyName && row.president_total > 0)
        .sort((a, b) => b.year - a.year)[0];
      
      if (recent) {
        const demPct = (recent.president_dem / recent.president_total) * 100;
        const repPct = (recent.president_rep / recent.president_total) * 100;
        const margin = demPct - repPct;
        const winner = margin > 0 ? 'D' : 'R';
        const marginAbs = Math.abs(margin);
        
        return `<div class="quick-tooltip">
          <strong>${countyName} County</strong><br>
          ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
          <em>Click for full trends</em>
        </div>`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${countyName} County</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    function getQuickDistrictInfo(districtNum, type) {
      let displayName = '';
      let recent = null;
      
      if (type === 'congressional') {
        displayName = `Congressional District ${districtNum}`;
        recent = congressionalData
          .filter(row => row.district == districtNum && row.us_house_total > 0)
          .sort((a, b) => b.year - a.year)[0];
          
        if (recent) {
          const demPct = (recent.us_house_dem / recent.us_house_total) * 100;
          const repPct = (recent.us_house_rep / recent.us_house_total) * 100;
          const margin = demPct - repPct;
          const winner = margin > 0 ? 'D' : 'R';
          const marginAbs = Math.abs(margin);
          
          return `<div class="quick-tooltip">
            <strong>${displayName}</strong><br>
            ${recent.year}: ${winner}+${marginAbs.toFixed(1)}%<br>
            <em>Click for full trends</em>
          </div>`;
        }
      } else if (type === 'house') {
        displayName = `State House District ${districtNum}`;
      } else if (type === 'senate') {
        displayName = `State Senate District ${districtNum}`;
      }
      
      return `<div class="quick-tooltip">
        <strong>${displayName}</strong><br>
        <em>Click for details</em>
      </div>`;
    }

    async function init() {
      try {
        setStatus('Loading counties...');
        console.log('Loading counties from:', CONFIG.paths.counties);
        const counties = await loadJSON(CONFIG.paths.counties);
        console.log('Counties loaded successfully:', counties.features?.length, 'features');
        
        // Store counties data globally for search functionality
        window.countiesData = counties;
        
        map.addSource('counties', { type: 'geojson', data: counties });
        
        countyNameMap = buildCountyNameMapFromGeoJSON(counties);
        console.log('County name map built:', Object.keys(countyNameMap).length, 'counties');
        
        // Add initial county layers
        addCountyLayers();
        
        // Setup county search after counties are loaded
        setupCountySearch();

        setStatus('Counties loaded');

        setStatus('Loading election data...');
        console.log('Loading election data from:', CONFIG.paths.election);
        electionDataJSON = await loadJSON(CONFIG.paths.election);
        console.log('Election JSON loaded:', electionDataJSON);
        
        // Flatten JSON structure for compatibility with existing code
        electionData = flattenElectionJSON(electionDataJSON);
        console.log('Election data flattened:', electionData.length, 'records');
        setStatus('Election data loaded');

        populateContestSelectFromElectionJSON(electionData);

        map.fitBounds(CONFIG.fitBounds, { padding: 20 });

      } catch (e) {
        setStatus('Error: ' + e.message);
      }
    }

    function getCountyAggregates(results) {
      const agg = {};
      Object.values(results || {}).forEach(r => {
        const countyKey = (r.county || '').toString().trim();
        if (!countyKey) return;
        if (!agg[countyKey]) agg[countyKey] = { dem:0, rep:0, total:0 };
        agg[countyKey].dem += (r.dem_votes||0);
        agg[countyKey].rep += (r.rep_votes||0);
        agg[countyKey].total += (r.total_votes||0);
      });
      return agg;
    }

    function categoryColorForMargin(marginPct, winner) {
      // NC map criteria: exact same thresholds and colors
      if (marginPct >= 40) {
        return winner === 'R' ? '#67000d' : '#08306b'; // Annihilation
      } else if (marginPct >= 30 && marginPct <= 39.99) {
        return winner === 'R' ? '#a50f15' : '#08519c'; // Dominant
      } else if (marginPct >= 20 && marginPct <= 29.99) {
        return winner === 'R' ? '#cb181d' : '#3182bd'; // Stronghold
      } else if (marginPct >= 10 && marginPct <= 19.99) {
        return winner === 'R' ? '#ef3b2c' : '#6baed6'; // Safe
      } else if (marginPct > 5.5 && marginPct <= 9.99) {
        return winner === 'R' ? '#fb6a4a' : '#9ecae1'; // Likely
      } else if (marginPct > 0.99 && marginPct <= 5.5) {
        return winner === 'R' ? '#fcae91' : '#c6dbef'; // Lean
      } else if (marginPct >= 0.5 && marginPct <= 0.99) {
        return winner === 'R' ? '#fee8c8' : '#e1f5fe'; // Tilt
      } else {
        return '#f7f7f7'; // Tossup
      }
    }

    function applyContest(contestKey) {
      if (!contestKey) return setStatus('Select a contest');
      
      // Split contest key properly - year is always the last part after final underscore
      const lastUnderscoreIndex = contestKey.lastIndexOf('_');
      const contestType = contestKey.substring(0, lastUnderscoreIndex);
      const year = contestKey.substring(lastUnderscoreIndex + 1);
      
      if (currentView === 'counties') {
        applyCountyContest(contestType, year);
      } else if (currentView === 'districts' && contestType === 'us_house') {
        // US House races use district-specific data
        applyDistrictContest(contestType, year);
      } else {
        // All other contests (statewide) aggregate county data by district
        applyStatewideContestToDistricts(contestType, year);
      }
    }

    function applyCountyContest(contestType, year) {
      // Filter data for this contest and year
      const contestData = electionData.filter(row => row.year == year);
      
      console.log(`Applying ${contestType} for ${year}:`, contestData.length, 'counties found');
      
      if (contestData.length === 0) {
        return setStatus('No data found for this contest');
      }

      // Store current results for county details using normalized county names
      function normalizeCountyName(name) {
        return (name || '')
          .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      currentElectionResults = {};
      contestData.forEach(row => {
        const norm = normalizeCountyName(row.county);
        currentElectionResults[norm] = row;
      });

      // Calculate statewide totals
      let statewidedemVotes = 0;
      let statewidrepVotes = 0;
      let statewidTotalVotes = 0;
      
      contestData.forEach(row => {
        const demVotes = row[`${contestType}_dem`] || 0;
        const repVotes = row[`${contestType}_rep`] || 0;
        const totalVotes = row[`${contestType}_total`] || 0;
        statewidedemVotes += demVotes;
        statewidrepVotes += repVotes;
        statewidTotalVotes += totalVotes; // Use total which includes other parties
      });
      
      // Update statewide results display
      updateStatewideResults(contestType, year, statewidedemVotes, statewidrepVotes, statewidTotalVotes);

      // Build expression for county coloring using normalized, uppercase names
      const expr = ['case'];
      let countiesProcessed = 0;
      // Normalization function (same as mergeGeoElectionData)
      function normalizeCountyName(name) {
        if (!name) return '';
        return name
          .replace(/[^a-z0-9 .\-]/gi, '')  // Keep periods for St. names and hyphens for Miami-Dade
          .replace(/\s+/g, ' ')
          .trim()
          .toUpperCase();
      }
      // Check if accessibility mode is active
      const isColorblindMode = document.body.classList.contains('colorblind-mode');
      
      // Define colorblind-friendly color function
      function getAccessibilityColor(marginPct, winner) {
        if (marginPct >= 40) {
          return winner === 'R' ? '#cc5500' : '#004d99';
        } else if (marginPct >= 30 && marginPct <= 39.99) {
          return winner === 'R' ? '#ff6600' : '#0066cc';
        } else if (marginPct >= 20 && marginPct <= 29.99) {
          return winner === 'R' ? '#ff8833' : '#0080ff';
        } else if (marginPct >= 10 && marginPct <= 19.99) {
          return winner === 'R' ? '#ffaa55' : '#3399ff';
        } else if (marginPct >= 5.51 && marginPct <= 9.99) {
          return winner === 'R' ? '#ffcc77' : '#66b3ff';
        } else if (marginPct >= 1 && marginPct <= 5.5) {
          return winner === 'R' ? '#ffdd99' : '#99ccff';
        } else if (marginPct >= 0.51 && marginPct <= 0.99) {
          return winner === 'R' ? '#ffeecc' : '#b3d9ff';
        } else {
          return '#cccccc';
        }
      }
      
      contestData.forEach(row => {
        const countyName = normalizeCountyName(row.county);
        const demVotes = row[`${contestType}_dem`] || 0;
        const repVotes = row[`${contestType}_rep`] || 0;
        const totalVotes = row[`${contestType}_total`] || 0;
        if (totalVotes === 0) return;
        const demPct = (demVotes / totalVotes) * 100;
        const repPct = (repVotes / totalVotes) * 100;
        const winner = repPct > demPct ? 'R' : 'D';
        const marginPct = Math.abs(repPct - demPct);
        // Use accessibility colors if colorblind mode is active
        const color = isColorblindMode ? getAccessibilityColor(marginPct, winner) : categoryColorForMargin(marginPct, winner);
        // Match on normalized, uppercase name from GeoJSON (NAME20 field)
        expr.push(['==', ['upcase', ['get', 'NAME20']], countyName]);
        expr.push(color);
        countiesProcessed++;
      });
      expr.push('#e0e0e0'); // default color
      
      console.log(`Color expression built for ${countiesProcessed} counties`);
      
      map.setPaintProperty('county-fill', 'fill-color', expr);
  document.getElementById('contest-name').textContent = `${formatContestName(contestType, year)} (${year})`;
      setStatus(`Applied contest: ${formatContestName(contestType, year)} ${year}`);
    }

    function applyDistrictContest(contestType, year) {
      if (contestType !== 'us_house') {
        return setStatus('Only US House races available for congressional districts');
      }
      
      // Filter congressional data for this year
      const contestData = congressionalData.filter(row => row.year == year);
      
      if (contestData.length === 0) {
        return setStatus('No congressional data found for this year');
      }

      // Build expression for district coloring
      const expr = ['case'];
      
      contestData.forEach(row => {
        const district = row.district;
        const demVotes = row.us_house_dem || 0;
        const repVotes = row.us_house_rep || 0;
        const totalVotes = row.us_house_total || 0;
        
        if (totalVotes === 0) return;
        
        const demPct = (demVotes / totalVotes) * 100;
        const repPct = (repVotes / totalVotes) * 100;
        const winner = repPct > demPct ? 'R' : 'D';
        const marginPct = Math.abs(repPct - demPct);
        const color = categoryColorForMargin(marginPct, winner);
        
        expr.push(['==', ['get', 'DISTRICT'], district]);
        expr.push(color);
      });
      
      expr.push('#e0e0e0'); // default color
      
      map.setPaintProperty('district-fill', 'fill-color', expr);
  document.getElementById('contest-name').textContent = `US House (${year})`;
      setStatus(`Applied contest: FL US House ${year}`);
    }

    function applyStatewideContestToDistricts(contestType, year) {
      // For statewide contests in district views, we need to aggregate county data by district
      const contestData = electionData.filter(row => row.year == year);

      if (contestData.length === 0) {
        return setStatus('No data found for this contest');
      }

      // Calculate statewide totals for this contest
      let totalDem = 0;
      let totalRep = 0;
      let totalVotes = 0;

      contestData.forEach(row => {
        const demVotes = Number(row[`${contestType}_dem`]) || 0;
        const repVotes = Number(row[`${contestType}_rep`]) || 0;
        const rowTotalVotes = Number(row[`${contestType}_total`]);
        if (!isNaN(rowTotalVotes) && rowTotalVotes > 0) {
          totalVotes += rowTotalVotes;
        } else {
          totalVotes += demVotes + repVotes;
        }
        totalDem += demVotes;
        totalRep += repVotes;
      });

      if (totalVotes === 0) {
        return setStatus(`No data found for ${contestType} in ${year}`);
      }

      const demPct = (totalDem / totalVotes) * 100;
      const repPct = (totalRep / totalVotes) * 100;
      const winner = repPct > demPct ? 'R' : 'D';
      const marginPct = Math.abs(repPct - demPct);
      const color = categoryColorForMargin(marginPct, winner);

      // Apply uniform color to all districts (showing statewide result)
      const layerName = currentView === 'districts' ? 'district-fill' : 
                       currentView === 'state_house' ? 'state-house-fill' : 'state-senate-fill';

      if (map.getLayer(layerName)) {
        map.setPaintProperty(layerName, 'fill-color', color);
      } else {
        setStatus('District layer not found!', 5000, true);
      }

  document.getElementById('contest-name').textContent = `${formatContestName(contestType, year)} (${year}) - Statewide Result`;
      setStatus(`Applied statewide contest: ${formatContestName(contestType, year)} ${year} (${demPct.toFixed(1)}% D, ${repPct.toFixed(1)}% R)`);
    }

    window.onload = init;
  </script>
</body>
</html>

